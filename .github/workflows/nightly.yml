name: Nightly Full Test Suite

on:
  schedule:
    # Run at 4:00 AM UTC every day (11 PM ET / 8 PM PT)
    - cron: '0 4 * * *'
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress nightly runs (only one should run at a time)
concurrency:
  group: nightly-tests
  cancel-in-progress: true

env:
  CC: ccache clang
  CXX: ccache clang++

jobs:
  # ===========================================================================
  # Shared build step — produces binary + test binary as artifacts
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-22.04
    timeout-minutes: 50

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        command: |
          sudo apt-get update
          sudo apt-get install -y \
            libsdl2-dev clang make python3 python3-venv npm \
            libssl-dev pkg-config libfmt-dev libcairo2-dev \
            libpango1.0-dev libpng-dev libjpeg-dev \
            libnl-3-dev libnl-genl-3-dev libxml2-utils ccache

    - name: Cache compiled dependencies
      uses: actions/cache@v4
      with:
        path: |
          build/lib/
          lib/libhv/lib/
          lib/libhv/include/hv/
          lib/tinygl/lib/
        key: deps-ubuntu-22.04-${{ hashFiles('lib/libhv/**/*.c', 'lib/libhv/**/*.cpp', 'lib/libhv/**/*.h', 'lib/tinygl/src/*.c', 'lib/tinygl/include/**/*.h', 'lib/wpa_supplicant/src/**/*.c', 'lib/wpa_supplicant/src/**/*.h', 'Makefile', 'mk/deps.mk') }}
        restore-keys: deps-ubuntu-22.04-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-nightly-${{ github.sha }}
        restore-keys: |
          ccache-nightly-
          ccache-ubuntu-22.04-

    - name: Install Node.js dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 2
        max_attempts: 3
        command: npm install

    - name: Configure ccache
      run: |
        ccache --set-config=max_size=500M
        ccache --set-config=compression=true
        ccache -z

    - name: Setup Python venv
      run: make venv-setup

    - name: Build application + tests
      timeout-minutes: 45
      run: |
        make -j$(nproc)
        make test
        ccache -s

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nightly-build
        path: |
          build/bin/helix-screen
          build/bin/helix-tests
        retention-days: 1

  # ===========================================================================
  # Test-all: every C++ test including [slow] (excludes only hidden [.] tests)
  # ===========================================================================
  test-all:
    name: All C++ Tests (incl. slow)
    needs: build
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install runtime deps
      run: |
        sudo apt-get update
        sudo apt-get install -y libsdl2-dev libfmt-dev libcairo2 libpango-1.0-0 libpng16-16 libjpeg8 libnl-3-200 libnl-genl-3-200

    - name: Download build
      uses: actions/download-artifact@v4
      with:
        name: nightly-build
        path: build/bin/

    - name: Fix permissions
      run: chmod +x build/bin/helix-screen build/bin/helix-tests

    - name: Run all tests (including slow)
      timeout-minutes: 20
      run: |
        echo "::group::Test run"
        ./build/bin/helix-tests "~[.]" --durations yes
        echo "::endgroup::"
        echo "All tests passed (including slow)"

  # ===========================================================================
  # Event loop / WebSocket stress tests (5-10 min, run separately)
  # ===========================================================================
  test-eventloop:
    name: Event Loop Stress Tests
    needs: build
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install runtime deps
      run: |
        sudo apt-get update
        sudo apt-get install -y libsdl2-dev libfmt-dev libcairo2 libpango-1.0-0 libpng16-16 libjpeg8 libnl-3-200 libnl-genl-3-200

    - name: Download build
      uses: actions/download-artifact@v4
      with:
        name: nightly-build
        path: build/bin/

    - name: Fix permissions
      run: chmod +x build/bin/helix-tests

    - name: Run eventloop tests
      timeout-minutes: 15
      run: |
        ./build/bin/helix-tests "[eventloop]" --durations yes
        echo "Event loop tests passed"

  # ===========================================================================
  # Shell / BATS tests (installer, service, platform scripts)
  # ===========================================================================
  test-shell:
    name: Shell Tests (BATS)
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install bats
      run: |
        sudo npm install -g bats

    - name: Run shell tests
      run: bats tests/shell/

  # ===========================================================================
  # AddressSanitizer — detect memory bugs, leaks, buffer overflows
  # ===========================================================================
  test-asan:
    name: AddressSanitizer
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        command: |
          sudo apt-get update
          sudo apt-get install -y \
            libsdl2-dev clang make python3 python3-venv npm \
            libssl-dev pkg-config libfmt-dev libcairo2-dev \
            libpango1.0-dev libpng-dev libjpeg-dev \
            libnl-3-dev libnl-genl-3-dev libxml2-utils ccache

    - name: Cache compiled dependencies
      uses: actions/cache@v4
      with:
        path: |
          build/lib/
          lib/libhv/lib/
          lib/libhv/include/hv/
          lib/tinygl/lib/
        key: deps-ubuntu-22.04-${{ hashFiles('lib/libhv/**/*.c', 'lib/libhv/**/*.cpp', 'lib/libhv/**/*.h', 'lib/tinygl/src/*.c', 'lib/tinygl/include/**/*.h', 'lib/wpa_supplicant/src/**/*.c', 'lib/wpa_supplicant/src/**/*.h', 'Makefile', 'mk/deps.mk') }}
        restore-keys: deps-ubuntu-22.04-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-asan-${{ github.sha }}
        restore-keys: |
          ccache-asan-
          ccache-nightly-
          ccache-ubuntu-22.04-

    - name: Install Node.js dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 2
        max_attempts: 3
        command: npm install

    - name: Configure ccache
      run: |
        ccache --set-config=max_size=500M
        ccache --set-config=compression=true
        ccache -z

    - name: Setup Python venv
      run: make venv-setup

    - name: Build and run with ASAN
      timeout-minutes: 45
      run: |
        make test-asan
        echo "ASAN tests complete"

    - name: Upload ASAN report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: asan-report
        path: /tmp/asan_output.txt
        retention-days: 7

  # ===========================================================================
  # ThreadSanitizer — detect data races
  # ===========================================================================
  test-tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        command: |
          sudo apt-get update
          sudo apt-get install -y \
            libsdl2-dev clang make python3 python3-venv npm \
            libssl-dev pkg-config libfmt-dev libcairo2-dev \
            libpango1.0-dev libpng-dev libjpeg-dev \
            libnl-3-dev libnl-genl-3-dev libxml2-utils ccache

    - name: Cache compiled dependencies
      uses: actions/cache@v4
      with:
        path: |
          build/lib/
          lib/libhv/lib/
          lib/libhv/include/hv/
          lib/tinygl/lib/
        key: deps-ubuntu-22.04-${{ hashFiles('lib/libhv/**/*.c', 'lib/libhv/**/*.cpp', 'lib/libhv/**/*.h', 'lib/tinygl/src/*.c', 'lib/tinygl/include/**/*.h', 'lib/wpa_supplicant/src/**/*.c', 'lib/wpa_supplicant/src/**/*.h', 'Makefile', 'mk/deps.mk') }}
        restore-keys: deps-ubuntu-22.04-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-tsan-${{ github.sha }}
        restore-keys: |
          ccache-tsan-
          ccache-nightly-
          ccache-ubuntu-22.04-

    - name: Install Node.js dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 2
        max_attempts: 3
        command: npm install

    - name: Configure ccache
      run: |
        ccache --set-config=max_size=500M
        ccache --set-config=compression=true
        ccache -z

    - name: Setup Python venv
      run: make venv-setup

    - name: Build and run with TSAN
      timeout-minutes: 45
      run: |
        make test-tsan
        echo "TSAN tests complete"

    - name: Upload TSAN report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tsan-report
        path: /tmp/tsan_output.txt
        retention-days: 7

  # ===========================================================================
  # Python tests (translations, telemetry analytics)
  # ===========================================================================
  test-python:
    name: Python Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Python tests
      run: pytest tests/python/ -v --tb=short

  # ===========================================================================
  # macOS cross-platform validation
  # ===========================================================================
  test-macos:
    name: macOS Tests
    runs-on: macos-14
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: brew install sdl2 ccache

    - name: Cache compiled dependencies
      uses: actions/cache@v4
      with:
        path: |
          build/lib/
          lib/libhv/lib/
          lib/libhv/include/hv/
          lib/tinygl/lib/
        key: deps-macos-14-${{ hashFiles('lib/libhv/**/*.c', 'lib/libhv/**/*.cpp', 'lib/libhv/**/*.h', 'lib/tinygl/src/*.c', 'lib/tinygl/include/**/*.h') }}
        restore-keys: deps-macos-14-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/ccache
        key: ccache-nightly-macos-${{ github.sha }}
        restore-keys: |
          ccache-nightly-macos-
          ccache-macos-14-

    - name: Install Node.js dependencies
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 2
        max_attempts: 3
        command: npm install

    - name: Configure ccache
      run: |
        ccache --set-config=max_size=500M
        ccache --set-config=compression=true
        ccache -z

    - name: Setup Python venv
      run: make venv-setup

    - name: Build HelixScreen
      timeout-minutes: 30
      run: make -j$(sysctl -n hw.ncpu)

    - name: Run all tests (including slow)
      timeout-minutes: 20
      run: make test-all

  # ===========================================================================
  # Final status gate
  # ===========================================================================
  nightly-status:
    name: Nightly Status
    runs-on: ubuntu-latest
    needs: [test-all, test-eventloop, test-shell, test-asan, test-tsan, test-python, test-macos]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "=== Nightly Test Results ==="
        echo "All C++ tests:    ${{ needs.test-all.result }}"
        echo "Event loop:       ${{ needs.test-eventloop.result }}"
        echo "Shell (BATS):     ${{ needs.test-shell.result }}"
        echo "ASAN:             ${{ needs.test-asan.result }}"
        echo "TSAN:             ${{ needs.test-tsan.result }}"
        echo "Python:           ${{ needs.test-python.result }}"
        echo "macOS:            ${{ needs.test-macos.result }}"
        echo "==========================="

        FAILED=0
        for job in test-all test-eventloop test-shell test-asan test-tsan test-python test-macos; do
          result="${{ needs[job].result }}" 2>/dev/null || result="unknown"
        done

        if [ "${{ needs.test-all.result }}" != "success" ] || \
           [ "${{ needs.test-eventloop.result }}" != "success" ] || \
           [ "${{ needs.test-shell.result }}" != "success" ] || \
           [ "${{ needs.test-asan.result }}" != "success" ] || \
           [ "${{ needs.test-tsan.result }}" != "success" ] || \
           [ "${{ needs.test-python.result }}" != "success" ] || \
           [ "${{ needs.test-macos.result }}" != "success" ]; then
          echo "::error::Nightly test suite had failures!"
          exit 1
        fi
        echo "All nightly tests passed!"
