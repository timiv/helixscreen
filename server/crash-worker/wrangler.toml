name = "helix-crash-worker"
main = "src/index.ts"
compatibility_date = "2024-12-01"
workers_dev = false

[vars]
GITHUB_REPO = "prestonbrown/helixscreen"
GITHUB_APP_ID = "2892859"
NOTIFICATION_EMAIL = "pbrown+helixscreen@brown-house.net"
EMAIL_FROM = "HelixScreen <noreply@helixscreen.org>"

# Secrets (set via wrangler secret put):
# INGEST_API_KEY          - matches key baked into HelixScreen binary
# GITHUB_APP_PRIVATE_KEY  - GitHub App RSA private key (PEM format)
# ADMIN_API_KEY           - Admin API key for retrieving debug bundles
# RESEND_API_KEY          - Resend API key for email notifications

[[routes]]
pattern = "crash.helixscreen.org/*"
zone_name = "helixscreen.org"

# Debug bundle storage
[[r2_buckets]]
binding = "DEBUG_BUNDLES"
bucket_name = "helix-debug-bundles"
jurisdiction = "eu"

# Symbol files for server-side backtrace resolution (shared with telemetry worker)
[[r2_buckets]]
binding = "TELEMETRY_BUCKET"
bucket_name = "helixscreen-telemetry"
jurisdiction = "eu"

# Rate limiting: 5 crash reports per IP per 60 seconds
# Prevents crash loops from flooding GitHub with duplicate issues
[[ratelimits]]
name = "CRASH_LIMITER"
namespace_id = "1002"
[ratelimits.simple]
limit = 5
period = 60

# Rate limiting for debug bundles: 3 per IP per 60 seconds
[[ratelimits]]
name = "DEBUG_BUNDLE_LIMITER"
namespace_id = "1003"
[ratelimits.simple]
limit = 3
period = 60
