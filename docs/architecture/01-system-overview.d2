# HelixScreen System Overview
direction: right

title: {
  label: HelixScreen System Overview
  near: top-center
  shape: text
  style.font-size: 28
  style.bold: true
}

# External Services
external: {
  label: External Services
  style.fill: "#1a1a2e"
  style.stroke: "#e94560"
  style.font-color: "#fff"

  moonraker: {
    label: "Moonraker\n(Klipper API)"
    shape: cloud
    style.fill: "#e94560"
  }
  spoolman: {
    label: "Spoolman\n(Filament DB)"
    shape: cloud
    style.fill: "#c77dba"
  }
  github: {
    label: "GitHub Releases\n(Updates)"
    shape: cloud
    style.fill: "#6c757d"
  }
  telemetry: {
    label: "telemetry.helixscreen.org"
    shape: cloud
    style.fill: "#6c757d"
  }
  releases: {
    label: "releases.helixscreen.org\n(Symbols + Binaries)"
    shape: cloud
    style.fill: "#6c757d"
  }
}

# Application
app: {
  label: "Application (main.cpp → Application::run)"
  style.fill: "#0f3460"
  style.font-color: "#fff"

  # Display Layer
  display: {
    label: Display Layer
    style.fill: "#3d405b"
    style.font-color: "#fff"

    dm: "DisplayManager\nLVGL + backend" { shape: rectangle }
    tm: "ThemeManager\nColors/tokens" { shape: rectangle }
    lm: "LayoutManager\nBreakpoints (sm/md/lg)" { shape: rectangle }
    am: "AssetManager\nFonts/icons/images" { shape: rectangle }
  }

  # UI Layer
  ui: {
    label: UI Layer
    style.fill: "#533483"
    style.font-color: "#fff"

    nav: "NavigationManager\nPanel + overlay stack" { shape: hexagon }
    panels: {
      label: "6 Main Panels"
      style.fill: "#7b2d8e"
      home: Home
      print: PrintSelect
      controls: Controls
      filament: Filament
      settings: Settings
      advanced: Advanced
    }
    overlays: "25+ Overlays\nMotion | PrintStatus | BedMesh\nAMS | Spoolman | Network | ..." { shape: rectangle }
    modals: "12+ Modals\nCancel | Edit | Confirm | Runout | ..." { shape: rectangle }
    toast: "NotificationManager\n+ ToastManager" { shape: rectangle }
    xml: "XML Components\nui_xml/*.xml\nDeclarative layouts + bindings" { shape: page }
  }

  # State Layer
  state: {
    label: State Layer
    style.fill: "#2b5876"
    style.font-color: "#fff"

    ps: "PrinterState\n~50 LVGL subjects\nTemps, motion, print progress" { shape: cylinder }
    as: "AmsState\nFilament backends\nAFC | HappyHare | ValgACE | ToolChanger" { shape: cylinder }
    ts: "ToolState\nMulti-tool tracking" { shape: cylinder }
    sm: "SettingsManager\nPersistent preferences" { shape: cylinder }
    fsm: "FilamentSensorManager\nRunout detection" { shape: rectangle }
    sensors: "Sensor Managers\nTemp | Humidity | Color\nWidth | Probe | Accel" { shape: rectangle }
  }

  # Communication Layer
  comms: {
    label: Communication Layer
    style.fill: "#4e4376"
    style.font-color: "#fff"

    mc: "MoonrakerClient\nWebSocket + JSON-RPC" { shape: diamond }
    ma: "MoonrakerAPI\nDomain operations\nhome_all() | set_temp() | ..." { shape: rectangle }
    mm: "MoonrakerManager\nLifecycle + notification queue" { shape: rectangle }
    pd: "PrinterDiscovery\nHardware detection" { shape: rectangle }
    pdt: "PrinterDetector\nModel identification\n(printer_database.json)" { shape: rectangle }
  }

  # System Layer
  system: {
    label: System Layer
    style.fill: "#1b4332"
    style.font-color: "#fff"

    cfg: "Config\nJSON settings" { shape: page }
    uq: "UpdateQueue\nThread-safe bridge\nqueue_update() → main thread" { shape: queue }
    snd: "SoundManager\nM300 / SDL audio" { shape: rectangle }
    uc: "UpdateChecker" { shape: rectangle }
    cr: "CrashReporter" { shape: rectangle }
    tlm: "TelemetryManager\nOpt-in analytics" { shape: rectangle }
    led: "LedController\n+ LedAutoState" { shape: rectangle }
    plg: "PluginManager\n+ PluginRegistry" { shape: rectangle }
  }

  # Lifecycle Layer
  lifecycle: {
    label: Lifecycle
    style.fill: "#5c2018"
    style.font-color: "#fff"

    ssr: "StaticSubjectRegistry\nSubject cleanup ordering" { shape: rectangle }
    spr: "StaticPanelRegistry\nPanel destruction ordering" { shape: rectangle }
    si: "SubjectInitializer\nPhased init orchestration" { shape: rectangle }
  }
}

# --- Connections ---

# External ↔ Comms
app.comms.mc <-> external.moonraker: "WebSocket\nJSON-RPC 2.0" {
  style.stroke: "#e94560"
  style.stroke-width: 3
}
app.comms.ma -> external.moonraker: "HTTP\nfile ops" {
  style.stroke: "#e94560"
  style.stroke-dash: 3
}
app.state.as -> external.spoolman: "REST API" { style.stroke: "#c77dba" }
app.system.uc -> external.github: "Poll releases" { style.stroke: "#6c757d" }
app.system.tlm -> external.telemetry: "POST events" { style.stroke: "#6c757d" }
app.system.cr -> external.telemetry: "POST crash" { style.stroke: "#6c757d" }
app.system.uc -> external.releases: "Download" { style.stroke: "#6c757d" }

# Comms → State
app.comms.mc -> app.comms.mm: notifications
app.comms.mm -> app.state.ps: "update_from_notification()"
app.state.ps -> app.state.as: status updates
app.state.ps -> app.state.ts: tool status
app.state.ps -> app.state.fsm: sensor status
app.state.ps -> app.state.sensors: sensor data

# State → UI (subject bindings)
app.state.ps -> app.ui.xml: "subjects" { style.stroke: "#00b4d8"; style.stroke-width: 2 }
app.state.as -> app.ui.xml: "subjects" { style.stroke: "#00b4d8" }
app.state.sm -> app.ui.xml: "subjects" { style.stroke: "#00b4d8" }

# XML → UI widgets
app.ui.xml -> app.ui.panels: "bind_text, bind_flag_if_eq"
app.ui.xml -> app.ui.overlays: "bind_text, bind_flag_if_eq"
app.ui.xml -> app.ui.modals: "bind_text"

# Navigation
app.ui.nav -> app.ui.panels: "activate/deactivate"
app.ui.nav -> app.ui.overlays: "push/pop"

# Threading bridge
app.comms.mc -> app.system.uq: "queue_update()\n(from libhv thread)" {
  style.stroke: "#ffd166"
  style.stroke-width: 2
}
app.system.uq -> app.state.ps: "lv_subject_set_*()\n(on main thread)" {
  style.stroke: "#ffd166"
  style.stroke-width: 2
}

# Display → Theme → XML
app.display.dm -> app.display.tm
app.display.tm -> app.ui.xml: "color tokens"

# Config
app.system.cfg -> app.state.sm
app.system.cfg -> app.state.ps
