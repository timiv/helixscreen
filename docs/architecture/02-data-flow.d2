# HelixScreen Data Flow
direction: down

title: {
  label: "Data Flow: Moonraker → Pixels"
  near: top-center
  shape: text
  style.font-size: 28
  style.bold: true
}

# --- Klipper / Moonraker ---
klipper: {
  label: "Klipper + Moonraker"
  style.fill: "#1a1a2e"
  style.font-color: "#fff"

  mcu: "Klipper MCU\ntemps, motion, endstops" { shape: rectangle }
  moonraker: "Moonraker Server\nAPI + WebSocket" { shape: cloud; style.fill: "#e94560" }
  mcu -> moonraker: "status updates"
}

# --- libhv Thread ---
libhv: {
  label: "libhv Thread (Background)"
  style.fill: "#4e4376"
  style.font-color: "#fff"

  ws: "WebSocket\nws://host:7125/websocket" { shape: diamond }
  client: "MoonrakerClient\nJSON-RPC 2.0 parser" { shape: rectangle }
  queue: "Notification Queue\n(std::queue + mutex)" { shape: queue }

  ws -> client: "JSON frames"
  client -> queue: "push"
}

klipper.moonraker <-> libhv.ws: "WebSocket" {
  style.stroke: "#e94560"
  style.stroke-width: 3
}

# --- Thread Boundary ---
barrier: {
  label: |md
    **THREAD BOUNDARY**
    `queue_update()` / mutex
  |
  shape: text
  style.font-size: 16
  style.font-color: "#ffd166"
  style.bold: true
}

libhv.queue -> barrier: {
  style.stroke: "#ffd166"
  style.stroke-width: 2
  style.stroke-dash: 5
}

# --- Main Thread ---
main: {
  label: "Main Thread (LVGL)"
  style.fill: "#0f3460"
  style.font-color: "#fff"

  loop: {
    label: "Main Loop (lv_timer_handler)"
    style.fill: "#16213e"

    uq: "1. UpdateQueue::process_pending()\n(highest priority - runs FIRST)" {
      shape: rectangle
      style.fill: "#ffd166"
      style.font-color: "#000"
    }
    process: "2. MoonrakerManager::process_notifications()\n(dequeue from background thread)" { shape: rectangle }
    render: "3. lv_refr_now()\n(LVGL render to framebuffer)" {
      shape: rectangle
      style.fill: "#06d6a0"
      style.font-color: "#000"
    }
    uq -> process -> render
  }

  state: {
    label: "State Processing"
    style.fill: "#2b5876"

    ps: "PrinterState::update_from_notification()\nExtracts values from JSON" { shape: rectangle }
    as: "AmsState::update_from_status()" { shape: rectangle }
    ts: "ToolState::update_from_status()" { shape: rectangle }
    fs: "FilamentSensorManager::update()" { shape: rectangle }
    sensors: "SensorManagers::update()\nTemp | Humidity | Color | Width | Accel" { shape: rectangle }

    ps -> as
    ps -> ts
    ps -> fs
    ps -> sensors
  }

  subjects: {
    label: "LVGL Subjects (~50+ reactive values)"
    style.fill: "#2b5876"
    style.stroke: "#00b4d8"

    temps: "Temperature subjects\nnozzle_temp, bed_temp, chamber_temp" { shape: cylinder }
    position: "Position subjects\npos_x, pos_y, pos_z" { shape: cylinder }
    print: "Print subjects\nprogress, filename, state, layers" { shape: cylinder }
    fans: "Fan subjects\npart_fan, aux_fan" { shape: cylinder }
    ams: "AMS subjects\nslots, active_tool, filament_type" { shape: cylinder }
    misc: "Settings, LED, network,\nplugin subjects..." { shape: cylinder }
  }

  bindings: {
    label: "XML Declarative Bindings"
    style.fill: "#533483"

    bind_text: 'bind_text="printer.filename"' { shape: rectangle }
    bind_int: 'bind_int="printer.temp" scale_divide="10"' { shape: rectangle }
    bind_flag: 'bind_flag_if_eq subject="state" ref_value="0"' { shape: rectangle }
    bind_style: 'bind_style subject="severity"' { shape: rectangle }
    event_cb: 'event_cb trigger="clicked" callback="on_home"' { shape: rectangle }
  }

  widgets: {
    label: "LVGL Widgets (Pixels on Screen)"
    style.fill: "#1b4332"

    labels: "Labels\n205°C | 60°C | 47%" { shape: rectangle }
    bars: "Progress Bars\nprint %, heat target" { shape: rectangle }
    images: "Images\nthumbnails, printer model" { shape: rectangle }
    buttons: "Buttons\nHome | Preheat | Cancel" { shape: rectangle }
  }
}

barrier -> main.loop.process

# State flow
main.loop.process -> main.state.ps: "JSON notification"
main.state.ps -> main.loop.uq: "queue_update(λ)" {
  style.stroke: "#ffd166"
  style.stroke-width: 2
}

# UpdateQueue → Subjects
main.loop.uq -> main.subjects.temps: "lv_subject_set_int()" {
  style.stroke: "#00b4d8"
}
main.loop.uq -> main.subjects.position: "lv_subject_set_int()"
main.loop.uq -> main.subjects.print: "lv_subject_set_str()"
main.loop.uq -> main.subjects.ams

# Subjects → Bindings (automatic observer fire)
main.subjects.temps -> main.bindings.bind_int: "observer fires" { style.stroke: "#00b4d8" }
main.subjects.print -> main.bindings.bind_text: "observer fires" { style.stroke: "#00b4d8" }
main.subjects.print -> main.bindings.bind_flag: "observer fires"
main.subjects.ams -> main.bindings.bind_style: "observer fires"

# Bindings → Widgets (automatic)
main.bindings.bind_text -> main.widgets.labels
main.bindings.bind_int -> main.widgets.labels
main.bindings.bind_flag -> main.widgets.bars: "show/hide"
main.bindings.bind_style -> main.widgets.buttons: "color"
main.bindings.event_cb -> main.widgets.buttons: "click handler"

# Widgets → Render
main.widgets.labels -> main.loop.render: "dirty region" { style.stroke: "#06d6a0" }
main.widgets.bars -> main.loop.render: "dirty region" { style.stroke: "#06d6a0" }

# Reverse flow (user input)
main.widgets.buttons -> main.bindings.event_cb: "user tap" {
  style.stroke: "#ef476f"
  style.stroke-dash: 3
}
main.bindings.event_cb -> libhv.client: "MoonrakerAPI call\n(e.g. home_all())" {
  style.stroke: "#ef476f"
  style.stroke-dash: 3
}
