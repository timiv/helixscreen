# HelixScreen Startup Sequence
direction: down

title: {
  label: "Application Startup Phases"
  near: top-center
  shape: text
  style.font-size: 28
  style.bold: true
}

phase1: {
  label: "Phase 1: Bootstrap"
  style.fill: "#1a1a2e"
  style.font-color: "#fff"

  a: "logging::init_early()" { shape: step }
  b: "parse_cli_args()\n-v/-vv/-vvv/--mock-printer" { shape: step }
  c: "Config::init(helixscreen.json)" { shape: step }
  d: "logging::init_full(verbosity)" { shape: step }

  a -> b -> c -> d
}

phase2: {
  label: "Phase 2: Display"
  style.fill: "#3d405b"
  style.font-color: "#fff"

  a: "DisplayManager::init()" { shape: step }
  b: "Auto-detect backend\n(fbdev / SDL / DRM)" { shape: step }
  c: "lv_init() + create display" { shape: step }
  d: "Setup input devices\n(touch / mouse / keyboard)" { shape: step }

  a -> b -> c -> d
}

phase3: {
  label: "Phase 3: Theme & Assets"
  style.fill: "#533483"
  style.font-color: "#fff"

  a: "ThemeManager::init()\nLoad color tokens, dark/light" { shape: step }
  b: "AssetManager::load()\nFonts, icons, images" { shape: step }
  c: "register_widgets()\nlv_obj_register_widget_class()" { shape: step }

  a -> b -> c
}

phase4: {
  label: "Phase 4: XML Components"
  style.fill: "#4e4376"
  style.font-color: "#fff"

  a: "register_xml_components()" { shape: step }
  b: "Semantic: text_heading, text_body,\nui_button, text_input, ui_spinner" { shape: step }
  c: "Custom: gcode_viewer, spool_canvas,\nhsv_picker, z_offset_indicator" { shape: step }
  d: "File-based: load ui_xml/*.xml\ncomponents/" { shape: step }
  e: "Load translations\n(lv_i18n)" { shape: step }

  a -> b -> c -> d -> e
}

phase5: {
  label: "Phase 5: Core Subjects"
  style.fill: "#2b5876"
  style.font-color: "#fff"

  a: "SubjectInitializer::init_core_and_state()" { shape: step }
  b: "PrinterState::init_subjects()\n~50 LVGL subjects\n+ StaticSubjectRegistry" {
    shape: step
    style.fill: "#ffd166"
    style.font-color: "#000"
  }
  c: "AmsState::init_subjects()" { shape: step }
  d: "ToolState + FilamentSensorManager\n+ All SensorManagers" { shape: step }

  a -> b -> c -> d
}

phase6: {
  label: "Phase 6: Moonraker"
  style.fill: "#4e4376"
  style.font-color: "#fff"

  a: "MoonrakerManager::init(config)" { shape: step }
  b: "Create MoonrakerClient\n(WebSocket transport)" { shape: step }
  c: "Create MoonrakerAPI\n(domain operations)" { shape: step }

  a -> b -> c
}

phase7: {
  label: "Phase 7: Panel Subjects"
  style.fill: "#2b5876"
  style.font-color: "#fff"

  a: "SubjectInitializer::init_panels(api)" { shape: step }
  b: "Inject MoonrakerAPI into panels" { shape: step }
  c: "Each panel::init_subjects()" { shape: step }
  d: "Register panel observers" { shape: step }

  a -> b -> c -> d
}

phase8: {
  label: "Phase 8: Create UI"
  style.fill: "#533483"
  style.font-color: "#fff"

  a: 'lv_xml_create("app_layout")' { shape: step }
  b: "Parse XML â†’ LVGL widget tree" { shape: step }
  c: "PanelFactory::wire_panels()\nFind by name, wire callbacks" { shape: step }
  d: "Create overlay instances" { shape: step }
  e: "NavigationManager::init()" { shape: step }

  a -> b -> c -> d -> e
}

phase9: {
  label: "Phase 9: Post-Init + Plugins"
  style.fill: "#1b4332"
  style.font-color: "#fff"

  a: "SubjectInitializer::init_post()" { shape: step }
  b: "PluginManager::load_plugins()" { shape: step }
  c: "Check for pending crash report" { shape: step }

  a -> b -> c
}

phase10: {
  label: "Phase 10: Connect + Run"
  style.fill: "#e94560"
  style.font-color: "#fff"

  a: "MoonrakerManager::connect()\nWebSocket handshake" { shape: step }
  b: "Receive initial state dump\nprinter.objects.list + subscribe" { shape: step }
  c: {
    label: |md
      **Main Loop (forever)**
      1. UpdateQueue::process_pending()
      2. process_notifications()
      3. lv_timer_handler()
    |
    shape: step
    style.fill: "#06d6a0"
    style.font-color: "#000"
  }

  a -> b -> c
}

# Connect phases
phase1 -> phase2 -> phase3 -> phase4 -> phase5 -> phase6 -> phase7 -> phase8 -> phase9 -> phase10

# Shutdown (reverse)
shutdown: {
  label: "Shutdown (reverse order)"
  style.fill: "#5c2018"
  style.font-color: "#fff"

  a: "MoonrakerManager::disconnect()\nClose WebSocket" { shape: step }
  b: "StaticPanelRegistry::destroy_all()\nPanel destructors + observer cleanup" { shape: step }
  c: "StaticSubjectRegistry::deinit_all()\nPrinterState, AmsState, etc." {
    shape: step
    style.fill: "#ffd166"
    style.font-color: "#000"
  }
  d: "lv_deinit()\n(safe: all observers disconnected)" { shape: step }

  a -> b -> c -> d
}
