# Update System (Developer Guide)

How the HelixScreen update system works internally: architecture, update channels, CDN distribution, download/install flow, Moonraker integration, and troubleshooting.

---

## Architecture Overview

The update system has three main components:

```
UpdateChecker (singleton, async update checker)
  |  Checks for new versions, manages download/install lifecycle.
  |  All network I/O runs on background threads; results dispatched to LVGL thread.
  |
  +-> R2 CDN (primary source)
  |     Fetches manifest.json from releases.helixscreen.org/{channel}/
  |     Platform-specific tarballs + SHA-256 checksums.
  |
  +-> GitHub API (fallback)
  |     /repos/prestonbrown/helixscreen/releases/latest (stable)
  |     /repos/prestonbrown/helixscreen/releases (beta — full array)
  |
  +-> Moonraker update_manager (parallel path)
        type: zip in moonraker.conf — enables updates from Mainsail/Fluidd web UI.
        Configured automatically by install.sh.
```

### Thread Model

```
LVGL thread (main)                    Worker thread (background)
  |                                     |
  check_for_updates(callback)           |
    |                                   |
    +-- cache channel config --+        |
    +-- spawn worker thread ---+------->|
    |                                   |
    |                          fetch_r2_manifest() or fetch_*_release()
    |                          parse JSON, compare versions
    |                          |
    |                          report_result() --- ui_queue_update() --->|
    |                                                                    |
    |<---- callback(status, ReleaseInfo) on LVGL thread -----------------+
```

Key safety rules:
- **Config** is read on the main thread and cached before spawning the worker (Config is NOT thread-safe).
- **LVGL subjects** are only updated via `ui_queue_update()` from background threads.
- **Downloads are blocked** while a print is in progress (`PrintJobState::PRINTING` or `PAUSED`).
- **Rate limited** to 1 check per hour minimum (`MIN_CHECK_INTERVAL`).

---

## Update Channels

Three channels are available. The channel is stored in config at `/update/channel` as an integer.

| Channel | Enum | Config Value | Source | Description |
|---------|------|-------------|--------|-------------|
| **Stable** | `UpdateChannel::Stable` | `0` | R2 `stable/manifest.json`, fallback: GitHub `/releases/latest` | Production releases only. Default for all users. |
| **Beta** | `UpdateChannel::Beta` | `1` | R2 `beta/manifest.json`, fallback: GitHub `/releases` array (first prerelease) | Includes pre-release tags (`v1.0.0-beta.1`, `v1.0.0-rc.1`). Falls back to latest stable if no prereleases exist. |
| **Dev** | `UpdateChannel::Dev` | `2` | R2 `dev/manifest.json`, or explicit `/update/dev_url` | Cutting-edge builds. Supports custom manifest URLs for local development servers. |

### Channel Selection in UI

The Update Channel dropdown is gated behind **beta features** (7-tap version easter egg in About). It appears in the About overlay (`about_overlay.xml`) and is bound to the `update_channel` LVGL subject managed by `SettingsManager`.

Options string: `"Stable\nBeta\nDev"`

### Dev Channel Custom URL

The dev channel supports an explicit URL override via config:

```json
{
  "update": {
    "channel": 2,
    "dev_url": "http://192.168.1.100:8080/dev/"
  }
}
```

When `dev_url` is set, the checker fetches `{dev_url}/manifest.json` directly instead of using R2. The URL must use `http://` or `https://` scheme. This is useful for testing dev builds served from a local machine.

### How CI Determines Upload Channels

In the release workflow (`.github/workflows/release.yml`):
- **Stable tags** (`v0.9.5`): uploaded to `stable` + `dev` channels
- **Prerelease tags** (`v1.0.0-beta.1`): uploaded to `beta` + `dev` channels

This means the dev channel always has the newest build regardless of stability.

---

## R2 CDN Distribution

The primary update source is the R2 CDN at `releases.helixscreen.org`. This avoids GitHub API rate limits and provides faster downloads.

### Manifest Format

All channels use the same manifest schema, generated by `scripts/generate-manifest.sh`:

```json
{
  "version": "0.9.5",
  "tag": "v0.9.5",
  "notes": "Bug fixes and stability improvements",
  "published_at": "2026-02-07T10:00:00Z",
  "assets": {
    "pi": {
      "url": "https://releases.helixscreen.org/stable/helixscreen-pi-v0.9.5.tar.gz",
      "sha256": "abc123...",
      "zip_url": "https://releases.helixscreen.org/stable/helixscreen-pi.zip",
      "zip_sha256": "def456..."
    },
    "pi32": { ... },
    "ad5m": { ... },
    "k1": { ... }
  }
}
```

Fields:
- `version` — Semver string without `v` prefix
- `tag` — Git tag with `v` prefix
- `notes` — Release notes (may be sparse; enriched with CHANGELOG.md at runtime)
- `published_at` — ISO 8601 timestamp
- `assets` — Object keyed by platform (`pi`, `pi32`, `ad5m`, `k1`, `k2`)
  - `url` — Direct download URL for the `.tar.gz` tarball
  - `sha256` — SHA-256 hash of the tarball
  - `zip_url` / `zip_sha256` — ZIP variant used by Moonraker `type: zip` updates

### URL Structure

```
https://releases.helixscreen.org/
  stable/
    manifest.json
    helixscreen-pi-v0.9.5.tar.gz
    helixscreen-pi.zip
    helixscreen-ad5m-v0.9.5.tar.gz
    ...
  beta/
    manifest.json
    helixscreen-pi-v1.0.0-beta.1.tar.gz
    ...
  dev/
    manifest.json
    ...
  symbols/
    v0.9.5/
      pi.sym
      ad5m.sym
      ...
```

### R2 Base URL Override

The R2 base URL can be overridden in config for testing:

```json
{
  "update": {
    "r2_url": "https://my-test-cdn.example.com"
  }
}
```

Default: `https://releases.helixscreen.org` (compiled as `DEFAULT_R2_BASE_URL`).

### GitHub API Fallback

If the R2 manifest fetch fails (network error, HTTP error, missing manifest), the checker falls back to the GitHub API:

- **Stable**: `GET /repos/prestonbrown/helixscreen/releases/latest` — parses single release object
- **Beta**: `GET /repos/prestonbrown/helixscreen/releases` — scans array for first non-draft prerelease, falls back to latest stable

GitHub responses are parsed for platform-specific assets by matching the prefix `helixscreen-{platform}-` in asset names. No fallback to arbitrary `.tar.gz` files -- wrong-platform binaries could brick embedded devices.

### Changelog Enrichment

R2 manifests may have sparse release notes. After a successful R2 fetch, the checker fetches `CHANGELOG.md` from the GitHub repo's main branch and extracts the section for the detected version. This provides full Keep a Changelog formatted notes in the notification modal.

---

## Platform Detection

The platform key is determined at compile time via preprocessor defines:

| Define | Platform Key | Devices |
|--------|-------------|---------|
| `HELIX_PLATFORM_AD5M` | `ad5m` | Flashforge Adventurer 5M |
| `HELIX_PLATFORM_K1` | `k1` | Creality K1 series |
| `HELIX_PLATFORM_K2` | `k2` | Creality K2 series. **Note:** K2 is supported in the UpdateChecker code but is not yet included in `generate-manifest.sh`. R2 manifests do not currently include K2 binaries. |
| `HELIX_PLATFORM_PI32` | `pi32` | Raspberry Pi (32-bit) |
| (default) | `pi` | Raspberry Pi (64-bit) |

Asset name format: `helixscreen-{platform}-{tag}.tar.gz` (e.g., `helixscreen-pi-v0.9.5.tar.gz`)

---

## Download and Install Flow

### State Machine

The download lifecycle is tracked by `DownloadStatus`:

```
Idle (0) ──> Confirming (1) ──> Downloading (2) ──> Verifying (3) ──> Installing (4) ──> Complete (5)
                 |                    |                  |                  |
                 v                    v                  v                  v
              (cancel)            (cancel)           Error (6)          Error (6)
                 |                    |                  |                  |
                 v                    v                  v                  v
              Idle (0)            Idle (0)         (Retry or Close)   (Retry or Close)
```

### Download Steps

1. **Safety check**: Refuses to download if a print is active or paused.
2. **Directory selection**: Scans candidate directories (`$TMPDIR`, `/tmp`, `/data`, `$HOME`, etc.) and picks the one with the **most free space** (minimum 50 MB required).
3. **HTTP download**: Uses `libhv requests::downloadFile()` with progress callback. UI updates throttled to every 2%.
4. **Size validation**: Rejects files < 1 MB or > 50 MB.
5. **Gzip verification**: Runs `gunzip -t` via `safe_exec()` (fork/exec, no shell).
6. **Architecture validation**: Extracts the binary from the tarball and reads the ELF header to verify it matches the runtime architecture (ARM 32-bit vs AARCH64 64-bit). This prevents installing a Pi 64-bit build on a 32-bit Pi or vice versa.
7. **Install**: Runs `install.sh --local {tarball} --update` via `safe_exec()`.

### Install Script Discovery

The installer is found by searching these paths in order:
1. Resolved from `/proc/self/exe` (strips `/bin/helix-screen` to find install root)
2. `/opt/helixscreen/install.sh`
3. `/root/printer_software/helixscreen/install.sh`
4. `/usr/data/helixscreen/install.sh`
5. `/home/biqu/helixscreen/install.sh`
6. `/home/pi/helixscreen/install.sh`
7. `scripts/install.sh` (development fallback)

### Safe Execution

All child processes are spawned via `safe_exec()` which uses `fork()/execvp()` directly, bypassing the shell entirely. This prevents command injection via crafted filenames or URLs. Stdout/stderr are redirected to `/dev/null`.

---

## Auto-Check Timer

After successful connection to a printer, `start_auto_check()` creates an LVGL timer:
- **Initial delay**: 15 seconds after startup
- **Periodic interval**: 24 hours (converted after the first check fires)

The auto-check callback:
1. Calls `check_for_updates()` with a notification callback
2. Skips notification if the version is **dismissed** (user previously chose "Ignore")
3. Skips notification if the printer is **printing or paused**
4. Populates release notes subject and shows `update_notify_modal`

### Dismissed Versions

Users can dismiss a specific version via the "Ignore" button. The dismissed version is stored in config at `/update/dismissed_version`. A version is considered dismissed if it is **less than or equal to** the dismissed version -- so only a *newer* version than what was dismissed triggers a notification.

---

## Moonraker Integration

HelixScreen registers itself with Moonraker's `update_manager` for updates via Mainsail/Fluidd web interfaces. This is a **parallel update path** -- users can update either from the HelixScreen touchscreen UI or from the web UI.

### Configuration Block

The installer appends this to `moonraker.conf`:

```ini
[update_manager helixscreen]
type: zip
channel: stable
repo: prestonbrown/helixscreen
path: /opt/helixscreen
managed_services: helixscreen
persistent_files:
    config/helixconfig.json
    config/.disabled_services
```

Key points:
- `type: zip` -- Moonraker downloads ZIP assets from GitHub releases (the manifest includes `zip_url` for each platform)
- `managed_services: helixscreen` -- Moonraker restarts the helixscreen service after update
- `persistent_files` -- Config files that survive updates
- `release_info.json` -- Written to the install directory so Moonraker can detect the installed version

### Service Allowlist

The installer also adds `helixscreen` to `moonraker.asvc` (the service management allowlist in the printer_data directory).

### Migration

The installer detects and migrates old `type: git_repo` configurations to `type: zip`, cleaning up any leftover sparse clone directories.

### Platform Scope

Moonraker integration is configured on **all platforms except AD5M** (which typically lacks a Mainsail/Fluidd web UI).

---

## User-Facing UI

### About Overlay (`about_overlay.xml`)

Located under Settings, the About overlay contains:
- **Current Version** row (7-tap to enable beta features)
- **Check for Updates** row (triggers manual check, description bound to `update_version_text` subject)
- **Install Update** row (visible only when `update_status == UpdateAvailable`)
- **Update Channel** dropdown (visible only when beta features enabled)

### Update Notification Modal (`update_notify_modal.xml`)

Shown automatically by auto-check when an update is found:
- Header with version info
- "View Changelog" toggle button that reveals a scrollable markdown area (`ui_markdown` bound to `update_release_notes`)
- "Ignore" button (dismisses this version) and "Install" button (opens download modal)

### Download Modal (`update_download_modal.xml`)

Multi-state modal driven by `download_status` subject:

| State | UI |
|-------|------|
| Confirming (1) | Version info + Cancel/Install buttons |
| Downloading (2) | Progress bar + percentage + Cancel button |
| Verifying (3) | Spinner + "Verifying..." text |
| Installing (4) | Spinner + "Installing..." + "Do not power off" warning |
| Complete (5) | Success icon + "Later" / "Restart Now" buttons |
| Error (6) | Error icon + error text + "Close" / "Retry" buttons |

### LVGL Subjects

| Subject | Type | Purpose |
|---------|------|---------|
| `update_status` | int | `Status` enum (Idle/Checking/UpdateAvailable/UpToDate/Error) |
| `update_checking` | int | 1 while check is in progress, 0 otherwise |
| `update_version_text` | string | Status text for the Check for Updates row |
| `update_new_version` | string | New version number (e.g., "0.9.6") |
| `update_current_version` | string | Current installed version. **Note:** This subject is owned by SettingsPanel, not UpdateChecker. |
| `update_channel` | int | Selected channel (managed by SettingsManager) |
| `download_status` | int | `DownloadStatus` enum |
| `download_progress` | int | 0-100 percentage |
| `download_text` | string | Status text shown in download modal |
| `update_release_notes` | string | Markdown release notes for notification modal |
| `update_changelog_visible` | int | Toggle for changelog visibility in notification |

---

## Configuration Reference

All update settings live under the `/update/` key in `helixconfig.json`:

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `/update/channel` | int | `0` | Update channel: 0=Stable, 1=Beta, 2=Dev |
| `/update/dev_url` | string | `""` | Custom manifest URL for dev channel |
| `/update/r2_url` | string | `""` | R2 base URL override (default: `https://releases.helixscreen.org`) |
| `/update/dismissed_version` | string | `""` | Version the user chose to ignore |

---

## Developer Guide

### Adding a New Platform

1. Add a `HELIX_PLATFORM_*` define and update `get_platform_key()` in `update_checker.cpp`
2. Add the platform to the `PLATFORMS` array in `scripts/generate-manifest.sh`
3. Add a build job in `.github/workflows/release.yml`
4. Add a `release-{platform}` target in the Makefile
5. Update `write_release_info()` in `scripts/lib/installer/moonraker.sh`

### Testing Update Checks

Run the program with `--test` mode and verbose logging:

```bash
./build/bin/helix-screen --test -vv
```

Navigate to Settings -> About -> Check for Updates. The log output shows the full check flow including R2 fetch, GitHub fallback, and version comparison.

### Testing with a Custom Dev Server

Serve a manifest locally:

```bash
# Build a local manifest
scripts/generate-manifest.sh \
  --version "99.0.0" \
  --tag "v99.0.0" \
  --notes "Test build" \
  --dir ./releases/ \
  --base-url "http://192.168.1.100:8080/dev" \
  --output ./manifest.json

# Serve it
python3 -m http.server 8080
```

Configure HelixScreen:

```json
{
  "update": {
    "channel": 2,
    "dev_url": "http://192.168.1.100:8080/"
  }
}
```

### Unit Tests

- `tests/unit/test_update_checker.cpp` — Version comparison, JSON parsing, status enums, lifecycle, subjects, dismissed versions, auto-check timer
- `tests/unit/test_update_channel.cpp` — Beta channel array parsing, dev manifest parsing, platform asset selection, channel config mapping, R2 URL resolution

Run with:

```bash
./build/bin/helix-tests "[update_checker]"
./build/bin/helix-tests "[update_channel]"
```

### Release Workflow

1. Tag a commit: `git tag v0.9.6` (stable) or `git tag v1.0.0-beta.1` (prerelease)
2. Push the tag: `git push origin v0.9.6`
3. CI builds all platforms (Pi, Pi32, AD5M, K1, K2) via Docker cross-compilation
4. CI creates GitHub release with tarballs + ZIPs
5. CI uploads to R2: tarballs, ZIPs, manifests, and symbol maps
6. Devices pick up the update on next auto-check (within 24 hours)

---

## Troubleshooting

### Update Check Fails

**Symptom**: "Error: Network request failed" or "Error: HTTP 403"

- Check network connectivity from the device
- R2 CDN may be down -- the checker automatically falls back to GitHub API
- GitHub API has rate limits (60 requests/hour unauthenticated). The 1-hour rate limit in UpdateChecker prevents this in normal use, but rapid restarts could exhaust it.
- Check logs: `./build/bin/helix-screen --test -vv` and look for `[UpdateChecker]` messages

### No Asset for Platform

**Symptom**: "No asset found for platform 'pi' in release X.Y.Z"

- The release may not have been built for this platform
- Check the manifest at `https://releases.helixscreen.org/stable/manifest.json`
- Verify `get_platform_key()` returns the expected value for the device

### Wrong Architecture

**Symptom**: "Error: Wrong architecture" during install

- The binary in the tarball doesn't match the device's CPU architecture
- This is an ELF header check: ARM 32-bit (`armv7l`) vs AARCH64 (`aarch64`)
- Ensure the correct platform tarball was downloaded (e.g., `pi32` for 32-bit Pi OS)

### Download Fails (No Space)

**Symptom**: "Error: No space for download"

- The checker requires at least 50 MB free in any writable directory
- Check disk space: `df -h`
- On embedded devices, `/tmp` may be a small tmpfs. The checker tries `/data`, `/mnt/data`, and other persistent storage paths.

### Install Script Not Found

**Symptom**: "Error: Installer not found"

- `install.sh` must be executable in the install directory
- Check: `ls -la /opt/helixscreen/install.sh` (or equivalent path)
- The checker searches multiple paths including resolving from the running binary's location

### Moonraker Update Not Showing

**Symptom**: HelixScreen doesn't appear in Moonraker's update manager

- Check that `[update_manager helixscreen]` exists in `moonraker.conf`
- Check that `helixscreen` is listed in `moonraker.asvc`
- Check that `release_info.json` exists in the install directory
- Restart Moonraker after config changes

### Debug Logging

Enable verbose logging for full update system trace:

```bash
./build/bin/helix-screen -vv  # DEBUG level shows all UpdateChecker messages
./build/bin/helix-screen -vvv # TRACE level for maximum detail
```

Or for deployed installations, set `HELIX_DEBUG=1` in `~/helixscreen/config/helixscreen.env` and restart the service.

---

## Key Files

| File | Purpose |
|------|---------|
| `include/system/update_checker.h` | UpdateChecker class declaration |
| `src/system/update_checker.cpp` | Full implementation (check, download, install, auto-check) |
| `src/system/settings_manager.cpp` | Channel subject and persistence |
| `src/ui/ui_panel_settings.cpp` | Download modal callbacks, channel change handler |
| `src/ui/ui_settings_about.cpp` | About overlay with check/install rows |
| `ui_xml/update_notify_modal.xml` | Auto-check notification modal |
| `ui_xml/update_download_modal.xml` | Multi-state download/install modal |
| `ui_xml/about_overlay.xml` | About panel with update controls |
| `scripts/generate-manifest.sh` | Manifest generator for CI and dev |
| `scripts/install.sh` | Bundled installer (used for `--update` mode) |
| `scripts/lib/installer/moonraker.sh` | Moonraker update_manager configuration |
| `.github/workflows/release.yml` | CI: build, release, R2 upload |
| `tests/unit/test_update_checker.cpp` | UpdateChecker unit tests |
| `tests/unit/test_update_channel.cpp` | Channel/manifest parsing tests |
