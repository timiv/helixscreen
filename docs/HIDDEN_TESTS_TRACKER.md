# Hidden Tests Tracker

**Last Updated:** 2026-01-08 (Phase 2 Update)
**Total Hidden Tests:** 100 (many are stubs awaiting implementation)
**Generated by:** Analyzing `[.]` tags in `tests/unit/*.cpp`

## Phase 2 Progress (2026-01-08)

### Infrastructure Created

- **`LVGLUITestFixture`** (`tests/lvgl_ui_test_fixture.h/.cpp`)
  - Full UI integration test fixture with production-like initialization
  - Registers fonts, images, theme, custom widgets, subjects, callbacks, and XML components
  - Follows CLAUDE.md rules: [L004], [L013], [L041] for initialization order
  - Can be used for complex panel and wizard tests

### Issues Identified & Fixed

- **Test hanging on mDNS timer processing**: Tests no longer hang after removing `process_lvgl()` calls during fixture construction
- **fmt/format.h include error**: Fixed in `test_moonraker_events.cpp` by using `spdlog/fmt/fmt.h`

### Test Categories Analyzed

| Category | Count | Status |
|----------|-------|--------|
| UI Integration (wizard) | 8 | **Failing** - need mDNS/Config mocking |
| Panel binding tests | 37 | **Skipped** - stubs awaiting implementation |
| Application integration | 32 | Hidden - need full app lifecycle |
| WiFi tests | 8 | Disabled - need real macOS WiFi |
| Moonraker robustness | 4 | Hidden - race conditions |

### Root Cause: Wizard Tests Failing

The 8 wizard connection UI tests now run (don't hang) but fail because:
1. `WizardConnectionStep` creates real mDNS discovery during `create()`
2. Config lookups happen during initialization
3. Widget bindings fail silently when subjects aren't registered

**Fix approach**: Create `WizardTestFixture` that mocks mDNS and Config, or inject test doubles.

---

## Recently Fixed (2026-01-08 - Phase 1)

- **MockPrint fixture destruction** (2 tests in test_mock_print_simulation.cpp)
  - Added condition_variable synchronization to MoonrakerClientMock temperature simulation
  - Thread now exits promptly on shutdown instead of waiting for sleep to complete

- **HelixMacroManager fixture tests** (6 tests in test_helix_macro_manager.cpp)
  - Tests were already passing - fixture doesn't use temperature simulation
  - Removed hidden tags to re-enable in normal test runs

- **Theme constants parallel isolation** - Fixed race condition in `test_ui_theme_constants.cpp`
  where multiple parallel shards used the same temp directory. Now uses PID-unique paths.

- **Input Shaper API tests** (7 tests in test_moonraker_api_input_shaper.cpp)
  - Added SHAPER_CALIBRATE response simulation to MoonrakerClientMock
  - Mock now dispatches realistic calibration output via dispatch_gcode_response()
  - Removed [.needs_mock_extension] tags

- **G-code RibbonGeometry tests** (2 tests in test_gcode_geometry_builder.cpp)
  - Tests were already passing - cache initialization was fixed in earlier commit
  - Removed hidden tags and outdated DEFERRED comment

---

## Overview

Hidden tests are excluded from normal test execution using Catch2's hidden tag mechanism (`[.]` prefix). They exist for various reasons:

- **Crashes/Instability**: Tests that cause crashes (SIGILL, SIGSEGV) during cleanup
- **External Dependencies**: Tests requiring live connections or hardware
- **Mock Limitations**: Tests blocked by incomplete mock implementations
- **Performance**: Tests too slow for normal CI runs
- **UI Integration**: Tests requiring full LVGL initialization

**Running hidden tests:**
```bash
# Run all hidden tests
./build/bin/helix-tests "[.]"

# Run by category
./build/bin/helix-tests "[.ui_integration]"
./build/bin/helix-tests "[.needs_mock_extension]"
./build/bin/helix-tests "[.benchmark]"
./build/bin/helix-tests "[.slow]"
```

---

## Summary Statistics

| Tag | Count | Description |
|-----|-------|-------------|
| `[.]` | 6 | Generic hidden (crashes, instability) |
| `[.ui_integration]` | 8 | Requires full LVGL/XML setup |
| `[.needs_mock_extension]` | 0 | Blocked by mock limitations |
| `[.network]` | 1 | Requires network connection |
| `[.integration]` | 1 | Requires external service |
| `[.benchmark]` | 1 | Performance measurement |
| `[.slow]` | 1 | Too slow for CI |
| `[.disabled]` | 1 | Temporarily disabled |

**By Priority:**
- HIGH (blocks important testing): 2
- MEDIUM (reduces coverage): 9
- LOW (working as designed): 8

---

## Hidden Test Inventory

### Exclude Object API Tests (1 test)

| File | Line | Test | Tags | Issue |
|------|------|------|------|-------|
| `test_moonraker_api_exclude_object.cpp` | 169 | Injection security | `[moonraker][security][injection][.]` | Unknown |

**Priority:** MEDIUM
**Root Cause:** Needs investigation
**Fix Approach:** TBD

---

### Moonraker Client Robustness Tests (4 tests)

| File | Line | Test | Tags | Issue |
|------|------|------|------|-------|
| `test_moonraker_client_robustness.cpp` | 97 | Concurrent sends | `[.][concurrent][priority1]` | Mutex lock failed during cleanup |
| `test_moonraker_client_robustness.cpp` | 252 | Concurrent callback registration | `[.slow][concurrent][priority1]` | **HANGS** - thread.join() never returns |
| `test_moonraker_client_robustness.cpp` | 617 | State machine | `[.][state][priority4]` | `send_jsonrpc` returns -1 when disconnected |
| `test_moonraker_client_robustness.cpp` | 887 | Sustained stress | `[.slow]` | Takes 10+ seconds (by design) |

**Priority:** HIGH (concurrent), MEDIUM (state), LOW (stress)
**Root Cause:** Race condition in cleanup; callback registration deadlock; behavior change; performance test
**Fix Approach:** Atomic flags for cleanup sync; investigate callback vector locking; review expected behavior; run manually
**Note:** Line 252 test causes `make test-run` to hang indefinitely - needs `[.]` tag or fix

---

### Moonraker Client Security Tests (2 tests)

| File | Line | Test | Tags | Issue |
|------|------|------|------|-------|
| `test_moonraker_client_security.cpp` | 364 | Timeout callbacks | `[.integration]` | Requires live WebSocket |
| `test_moonraker_client_security.cpp` | 812 | Security properties | `[.][integration]` | SIGSEGV during destruction |

**Priority:** HIGH
**Root Cause:** Needs live connection; callback cleanup race
**Fix Approach:** Mock WebSocket server; fix destructor cleanup

---

### G-code Data Source Tests (1 test)

| File | Line | Test | Tags | Issue |
|------|------|------|------|-------|
| `test_gcode_data_source.cpp` | 226 | MoonrakerDataSource construction | `[.network]` | Requires network |

**Priority:** LOW
**Root Cause:** By design - integration test
**Fix Approach:** Run explicitly when testing network features

---

### WiFi Manager Tests (1 test)

| File | Line | Test | Tags | Issue |
|------|------|------|------|-------|
| `test_wifi_manager.cpp` | 556 | Network information | `[.disabled]` | `scan_once()` returns before completion |

**Priority:** MEDIUM
**Root Cause:** Async API doesn't wait for scan completion
**Fix Approach:** Rewrite with callback pattern or explicit wait

---

### Wizard Connection UI Tests (8 tests)

| File | Line | Test | Tags | Status |
|------|------|------|------|--------|
| `test_wizard_connection_ui.cpp` | 79 | All widgets exist | `[.ui_integration]` | Runs, fails |
| `test_wizard_connection_ui.cpp` | 95 | Input field interaction | `[.ui_integration]` | Runs, fails |
| `test_wizard_connection_ui.cpp` | 128 | Test button state | `[.ui_integration]` | Runs, fails |
| `test_wizard_connection_ui.cpp` | 141 | Status label updates | `[.ui_integration]` | Runs, fails |
| `test_wizard_connection_ui.cpp` | 165 | Navigation buttons | `[.ui_integration]` | Runs, fails |
| `test_wizard_connection_ui.cpp` | 183 | Title and progress | `[.ui_integration]` | Runs, fails |
| `test_wizard_connection_ui.cpp` | 289 | Input validation feedback | `[.ui_integration]` | Runs, fails |
| `test_wizard_connection_ui.cpp` | 337 | Responsive layout | `[.ui_integration]` | Runs, fails |

**Priority:** MEDIUM
**Root Cause (Updated):** Tests now use `LVGLUITestFixture` which properly initializes XML. However, `WizardConnectionStep::create()` starts real mDNS discovery and Config lookups. Widget bindings fail because step-specific subjects aren't fully registered before XML creation.
**Fix Approach:**
1. Mock mDNS discovery to avoid network activity in tests
2. Mock Config lookups to provide test values
3. Ensure step subjects are registered before XML parsing

---

### Wizard Connection Performance (1 test)

| File | Line | Test | Tags | Issue |
|------|------|------|------|-------|
| `test_wizard_connection.cpp` | 327 | Performance benchmark | `[.benchmark]` | Runs 10000 iterations |

**Priority:** LOW (working as designed)
**Root Cause:** Performance test, excluded from fast CI
**Fix Approach:** Run explicitly: `./build/bin/helix-tests "[.benchmark]"`

---

## Standardized Hidden Tag Conventions

| Tag | Meaning | When to Use |
|-----|---------|-------------|
| `[.]` | Generic hidden | Crashes, instability, catch-all |
| `[.needs_mock_extension]` | Mock limitations | Test blocked by incomplete mock |
| `[.ui_integration]` | Requires UI infrastructure | Needs full LVGL/XML initialization |
| `[.integration]` | Requires external resources | Live server, hardware, etc. |
| `[.network]` | Requires network | Network-dependent tests |
| `[.benchmark]` | Performance measurement | Timing-sensitive, slow |
| `[.slow]` | Too slow for normal runs | >5 seconds execution |
| `[.disabled]` | Temporarily disabled | Awaiting fix or decision |
| `[.flaky]` | Intermittent failures | Race conditions, timing |

---

## Action Items (Prioritized)

### HIGH Priority

1. **Fix Moonraker client robustness issues** (2 tests)
   - Concurrent sends mutex lock failure during cleanup
   - Security properties SIGSEGV during destruction

### MEDIUM Priority

2. **Set up UI integration test infrastructure** (8 tests)
3. **Fix WiFi scan_once() async behavior** (1 test)

### LOW Priority

4. **Document slow/benchmark tests** - working as designed
5. **Review state machine test expectations** - may need behavior update

---

## Verification Command

Run this to verify document accuracy:
```bash
echo "Hidden tests:" && grep -rn '\[\.' tests/unit/*.cpp | grep -v '^ *//' | grep -v 'Run tests' | wc -l
```

Expected output: `19`
