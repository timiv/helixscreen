<?xml version="1.0"?>
<!-- Copyright 2025 HelixScreen -->
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<component>
  <!-- Component-local constants -->
  <consts>
    <!-- Column widths for two-column layout (right column shrunk for more spool space) -->
    <percentage name="left_col_width" value="70%"/>
    <percentage name="right_col_width" value="28%"/>
    <!-- Current loaded swatch size (compact to fit dryer card) -->
    <px name="current_swatch_size" value="40"/>
    <!-- Status spinner size -->
    <px name="spinner_size" value="28"/>
  </consts>
  <!-- Overlay panel - right-aligned, uses standard large width -->
  <view name="ams_panel"
        extends="lv_obj" width="#overlay_panel_width_large" height="100%" align="right_mid" style_pad_all="0"
        style_border_width="0" style_bg_opa="255" style_bg_color="#card_bg" scrollable="false" flex_flow="column">
    <!-- Header Bar -->
    <header_bar name="overlay_header" title="Multi-Filament"/>
    <!-- Content Area: Two Columns -->
    <lv_obj name="overlay_content"
            width="100%" flex_grow="1" style_bg_opa="0" style_pad_all="#space_lg" style_pad_gap="#space_lg"
            scrollable="false" style_border_width="0" flex_flow="row" style_flex_main_place="space_between"
            style_flex_cross_place="stretch">
      <!-- ================================================================== -->
      <!-- LEFT COLUMN: AMS Unit Visualization                               -->
      <!-- ================================================================== -->
      <lv_obj name="left_column"
              width="#left_col_width" height="100%" style_bg_opa="0" style_pad_all="0" style_border_width="0"
              scrollable="false" flex_flow="column" style_flex_main_place="start" style_flex_cross_place="center"
              style_pad_gap="#space_xs">
        <!-- Section Header: System Logo + Name (centered above slots) -->
        <lv_obj name="system_header"
                width="100%" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="row"
                style_flex_main_place="center" style_flex_cross_place="center" style_pad_gap="#space_sm"
                scrollable="false">
          <!-- Logo image - set programmatically based on AMS type -->
          <lv_image name="system_logo" width="24" height="24" inner_align="contain"/>
          <text_body name="system_name_label" bind_text="ams_system_name"/>
        </lv_obj>
        <!-- AMS Unit Card - contains the slot grid with tray effect -->
        <ui_card name="ams_unit_card"
                 width="100%" height="content" style_radius="#border_radius_large" style_pad_all="#space_sm"
                 style_border_width="0" scrollable="false">
          <!-- Wrapper for layered tray + slots (not flex, allows absolute positioning) -->
          <lv_obj name="slot_area"
                  width="100%" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0"
                  scrollable="false" overflow="visible">
            <!-- Slot Grid Container (drawn first = behind)
                 Uses flex_grow=1 on slots to divide space equally.
                 Slot centers align with path canvas slot entry points:
                 slot_x = card_padding + segment/2 + i*segment (where segment = effective_width/slot_count)
                 Slots are created dynamically by C++ based on slot_count subject. -->
            <lv_obj name="slot_grid"
                    width="content" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0"
                    style_pad_row="0" style_pad_column="0" flex_flow="row" style_flex_main_place="start"
                    style_flex_cross_place="start" scrollable="false" overflow="visible">
              <!-- Slots created dynamically by AmsPanel::create_slots() based on slot_count -->
            </lv_obj>
            <!-- Tray - visual "holder" in front of spools, positioned at bottom
                 Height set dynamically by C++ to 1/3 of slot height -->
            <lv_obj name="slot_tray"
                    width="100%" height="30" align="bottom_mid" style_bg_color="#text_secondary" style_bg_opa="38"
                    style_border_width="1" style_border_color="#text_secondary" style_border_opa="80"
                    style_radius="#border_radius" style_pad_all="0" scrollable="false" clickable="false">
              <!-- Left side border line (only left edge visible) -->
              <lv_obj width="4"
                      height="80%" align="left_mid" style_translate_x="4" style_bg_opa="0"
                      style_border_width="2" style_border_color="#text_primary" style_border_opa="200"
                      style_border_side="left" style_radius="#border_radius" style_pad_all="0"
                      scrollable="false" clickable="false"/>
              <!-- Right side border line (only right edge visible) -->
              <lv_obj width="4"
                      height="80%" align="right_mid" style_translate_x="-4" style_bg_opa="0"
                      style_border_width="2" style_border_color="#text_primary" style_border_opa="200"
                      style_border_side="right" style_radius="#border_radius" style_pad_all="0"
                      scrollable="false" clickable="false"/>
            </lv_obj>
            <!-- Labels Layer - renders ON TOP of slots so labels aren't obscured by overlapping slots
                 Height matches slot stagger area; set dynamically by C++ for different gate counts -->
            <lv_obj name="labels_layer"
                    width="100%" height="80" style_bg_opa="0" style_border_width="0" style_pad_all="0"
                    scrollable="false" clickable="false" overflow="visible"/>
          </lv_obj>
        </ui_card>
        <!-- Path Canvas - shows routing from slots to nozzle (no card border)
             Uses flex_grow="1" to fill remaining vertical space in left column -->
        <lv_obj name="path_container"
                width="100%" flex_grow="1" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="column"
                style_flex_main_place="start" style_flex_cross_place="center" scrollable="false" overflow="visible">
          <!-- Filament Path Canvas
               Shows schematic view of filament routing:
               - Slots at top (entry points)
               - Prep sensors (for AFC/hub topology)
               - Hub/Selector in center
               - Output to toolhead sensor
               - Nozzle at bottom

               All configuration (slot_count, topology, active_slot, etc.)
               set programmatically by C++ from AmsState/backend data.
               Click on slot entry points to trigger filament load.

               Uses flex_grow="1" so canvas height scales with screen size.
               All vertical segments scale proportionally via Y ratios. -->
          <filament_path_canvas name="path_canvas" width="100%" flex_grow="1"/>
        </lv_obj>
      </lv_obj>
      <!-- ================================================================== -->
      <!-- RIGHT COLUMN: Status & Controls                                   -->
      <!-- ================================================================== -->
      <lv_obj name="right_column"
              width="#right_col_width" height="100%" style_bg_opa="0" style_pad_all="0" style_border_width="0"
              scrollable="false" flex_flow="column" style_flex_main_place="start" style_flex_cross_place="center"
              style_pad_gap="#space_sm">
        <!-- Currently Loaded Section Header -->
        <text_small width="100%" text="Currently Loaded" style_text_color="#text_secondary"/>
        <!-- Currently Loaded Card - horizontal layout: swatch left, details stacked right -->
        <ui_card name="current_loaded_card"
                 width="100%" height="content" style_radius="#border_radius_large" style_pad_all="#space_sm"
                 flex_flow="row" style_flex_main_place="start" style_flex_cross_place="center" style_pad_gap="#space_sm">
          <!-- Color swatch for current filament (left side) -->
          <lv_obj name="current_swatch"
                  width="#current_swatch_size" height="#current_swatch_size" style_radius="#border_radius"
                  style_bg_color="#text_secondary" style_bg_opa="255" style_border_width="2"
                  style_border_color="#text_secondary" style_border_opa="80" scrollable="false" clickable="false"/>
          <!-- Details column (stacked to the right of swatch) -->
          <!-- flex_grow="1" fills remaining width after swatch for text wrapping -->
          <lv_obj name="current_details"
                  height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0"
                  flex_flow="column" style_flex_main_place="center" style_flex_cross_place="start" style_pad_gap="0"
                  scrollable="false" flex_grow="1">
            <!-- Primary label: material name (wraps for long names like "Generic / PLA") -->
            <text_body name="current_material" bind_text="ams_current_material_text"
                       width="100%" long_mode="wrap"/>
            <!-- Secondary info row: Slot • Weight -->
            <lv_obj name="secondary_info_row"
                    width="content" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0"
                    flex_flow="row" style_flex_main_place="start" style_pad_gap="#space_xs" scrollable="false">
              <!-- Slot indicator -->
              <text_small name="current_slot_label" bind_text="ams_current_slot_text" style_text_color="#text_secondary"/>
              <!-- Separator dot - hidden when no weight data -->
              <text_small name="weight_separator" text="•" style_text_color="#text_secondary">
                <bind_flag_if_eq subject="ams_current_has_weight" flag="hidden" ref_value="0"/>
              </text_small>
              <!-- Weight - hidden when not available -->
              <text_small name="current_weight_label"
                          bind_text="ams_current_weight_text" style_text_color="#text_secondary">
                <bind_flag_if_eq subject="ams_current_has_weight" flag="hidden" ref_value="0"/>
              </text_small>
            </lv_obj>
          </lv_obj>
        </ui_card>
        <!-- Status Section -->
        <lv_obj name="status_section"
                width="100%" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="#space_sm"
                flex_flow="row" style_flex_main_place="center" style_flex_cross_place="center" style_pad_gap="#space_sm"
                scrollable="false">
          <!-- Progress spinner (hidden by default, shown during operations) -->
          <lv_spinner name="action_progress"
                      width="#spinner_size" height="#spinner_size" style_arc_width_indicator="3"
                      style_arc_color="#primary_color" style_arc_opa_main="0" hidden="true"/>
          <!-- Status label - bound to ams_action_detail subject -->
          <text_body name="status_label" bind_text="ams_action_detail" style_text_align="center" flex_grow="1"/>
        </lv_obj>
        <!-- Action Buttons -->
        <lv_obj width="100%"
                height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" style_pad_gap="#space_sm"
                flex_flow="column" style_flex_main_place="start" style_flex_cross_place="center" scrollable="false">
          <!-- Bypass Toggle Row (visible when supports_bypass) -->
          <lv_obj name="bypass_row"
                  width="100%" height="#button_height" style_bg_opa="0" style_border_width="0" style_pad_all="0"
                  flex_flow="row" style_flex_main_place="space_between" style_flex_cross_place="center"
                  scrollable="false">
            <bind_flag_if_eq subject="ams_supports_bypass" flag="hidden" ref_value="0"/>
            <!-- Left side: icon + label -->
            <lv_obj width="content"
                    height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="row"
                    style_flex_cross_place="center" style_pad_gap="#space_xs" scrollable="false">
              <icon src="source_branch" size="sm"/>
              <text_body text="Bypass"/>
            </lv_obj>
            <!-- Right side: toggle switch - state bound to bypass_active subject -->
            <lv_switch name="bypass_switch">
              <bind_state_if_eq subject="bypass_active" state="checked" ref_value="1"/>
              <event_cb trigger="value_changed" callback="ams_bypass_toggled_cb"/>
            </lv_switch>
          </lv_obj>
          <!-- Unload Button (full width) -->
          <lv_button name="btn_unload"
                     width="100%" height="#button_height" style_radius="#border_radius" style_border_width="0"
                     style_shadow_width="0">
            <icon src="tray_arrow_up" size="sm" align="left_mid" style_translate_x="#space_sm"/>
            <text_body text="Unload" align="center"/>
            <event_cb trigger="clicked" callback="ams_unload_clicked_cb"/>
          </lv_button>
          <!-- Reset Button (full width) -->
          <lv_button name="btn_reset"
                     width="100%" height="#button_height" style_radius="#border_radius" style_border_width="0"
                     style_shadow_width="0">
            <icon src="refresh" size="sm" align="left_mid" style_translate_x="#space_sm"/>
            <text_body text="Reset" align="center"/>
            <event_cb trigger="clicked" callback="ams_reset_clicked_cb"/>
          </lv_button>
        </lv_obj>
        <!-- Dryer Card (hidden when dryer not supported) -->
        <ams_dryer_card name="dryer_card"/>
      </lv_obj>
    </lv_obj>
  </view>
</component>
