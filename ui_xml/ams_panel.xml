<?xml version="1.0"?>
<!-- Copyright (C) 2025-2026 356C LLC -->
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<component>
  <!-- Component-local constants -->
  <consts>
    <!-- Column widths for two-column layout (right column shrunk for more spool space) -->
    <percentage name="left_col_width" value="70%"/>
    <percentage name="right_col_width" value="28%"/>
    <!-- Current loaded swatch size (compact to fit dryer card) -->
    <px name="current_swatch_size" value="40"/>
    <!-- Spool tray styling - dark holder that obscures bottom of spools -->
    <color name="tray_bg" value="#505050"/>
    <color name="tray_border" value="#606060"/>
    <number name="tray_bg_opa" value="200"/>
    <number name="tray_border_opa" value="140"/>
    <px name="tray_default_height" value="30"/>
    <px name="tray_border_width" value="1"/>
    <!-- Tray side accent lines -->
    <percentage name="tray_accent_height" value="80%"/>
    <number name="tray_accent_border_opa" value="180"/>
    <px name="tray_accent_offset" value="2"/>
  </consts>
  <!-- Overlay panel - right-aligned, uses standard large width -->
  <view name="ams_panel"
        extends="lv_obj" width="#overlay_panel_width" height="100%" align="right_mid" style_pad_all="0"
        style_border_width="0" style_bg_opa="255" style_bg_color="#card_bg" scrollable="false" flex_flow="column">
    <!-- Header Bar -->
    <header_bar name="overlay_header" title="Multi-Filament" title_tag="Multi-Filament"/>
    <!-- Content Area: Two Columns -->
    <lv_obj name="overlay_content"
            width="100%" flex_grow="1" style_pad_all="#space_lg" style_pad_gap="#space_lg" scrollable="false"
            flex_flow="row" style_flex_main_place="space_between" style_flex_cross_place="start">
      <!-- ================================================================== -->
      <!-- LEFT COLUMN: AMS Unit Visualization                               -->
      <!-- ================================================================== -->
      <lv_obj name="left_column"
              width="#left_col_width" height="100%" style_pad_all="0" scrollable="false" flex_flow="column"
              style_flex_main_place="start" style_flex_cross_place="center" style_pad_gap="#space_xs">
        <!-- Backend selector (hidden by default, shown when multiple backends present) -->
        <lv_obj name="backend_selector_row" width="100%" height="content"
                style_pad_all="0" style_pad_bottom="#space_sm"
                flex_flow="row" style_flex_main_place="center" style_pad_gap="#space_xs"
                scrollable="false" flag_hidden="true">
          <!-- Segments created dynamically in C++ -->
        </lv_obj>
        <!-- Section Header: System Logo + Name (centered above slots) -->
        <lv_obj name="system_header"
                width="100%" height="content" style_pad_all="0" flex_flow="row" style_flex_main_place="center"
                style_flex_cross_place="center" style_pad_gap="#space_sm" scrollable="false">
          <!-- Logo image - set programmatically based on AMS type -->
          <lv_image name="system_logo" width="#space_2xl" height="#space_2xl" inner_align="contain"/>
          <text_body name="system_name_label" bind_text="ams_system_name"/>
        </lv_obj>
        <!-- AMS Unit Card - contains the slot grid with tray effect -->
        <ui_card name="ams_unit_card"
                 width="100%" height="content" style_radius="#border_radius" style_pad_all="#space_sm"
                 style_border_width="0" scrollable="false">
          <!-- Wrapper for layered tray + slots - uses flex column for proper arrow placement -->
          <lv_obj name="slot_area"
                  width="100%" height="content" style_pad_all="0" scrollable="false"
                  flex_flow="column" style_flex_main_place="start" style_flex_cross_place="center">
            <!-- Endless Spool Arrows - shows backup relationships between slots
                 Positioned at TOP of slot area, ABOVE the slots.
                 Arrows show up-over-down connections between slots. -->
            <endless_spool_arrows name="endless_arrows"
                                  width="100%" height="45" clickable="false" scrollable="false" style_bg_opa="0"/>
            <!-- Slots wrapper - contains grid, tray, and labels with relative positioning -->
            <lv_obj name="slots_wrapper"
                    width="100%" height="content" style_pad_all="0" scrollable="false">
              <!-- Slot Grid Container (drawn first = behind)
                   Uses flex_grow=1 on slots to divide space equally.
                   Slot centers align with path canvas slot entry points:
                   slot_x = card_padding + segment/2 + i*segment (where segment = effective_width/slot_count)
                   Slots are created dynamically by C++ based on slot_count subject. -->
              <lv_obj name="slot_grid"
                      width="content" height="content" style_pad_all="0" style_pad_row="0" style_pad_column="0"
                      flex_flow="row" style_flex_main_place="start" style_flex_cross_place="start" scrollable="false">
                <!-- Slots created dynamically by AmsPanel::create_slots() based on slot_count -->
              </lv_obj>
              <!-- Endless Spool Arrows - shows backup relationships between slots
                   Positioned at top of slot area, overlapping labels area.
                   Uses absolute positioning relative to slot_area so it renders above spools. -->
              <endless_spool_arrows name="endless_arrows"
                                    width="100%" height="50" align="top_mid" clickable="false" scrollable="false"
                                    style_bg_opa="0"/>
              <!-- Labels Layer - renders ON TOP of slots so labels aren't obscured by overlapping slots
                   Height matches slot stagger area; set dynamically by C++ for different gate counts -->
              <lv_obj name="labels_layer"
                      width="100%" height="80" style_pad_all="0" scrollable="false" clickable="false"/>
              <!-- Tray - visual "holder" in front of spools, positioned at bottom
                   Height set dynamically by C++ to 1/3 of slot height -->
              <lv_obj name="slot_tray"
                      width="100%" height="#tray_default_height" align="bottom_mid"
                      style_bg_color="#tray_bg" style_bg_opa="#tray_bg_opa"
                      style_border_width="#tray_border_width" style_border_color="#tray_border" style_border_opa="#tray_border_opa"
                      style_radius="#border_radius" style_pad_all="0" scrollable="false" clickable="false">
                <!-- Left side accent line -->
                <lv_obj width="#space_xs" height="#tray_accent_height" align="left_mid"
                        style_translate_x="#space_xs" style_border_width="#space_xxs"
                        style_border_color="#text" style_border_opa="#tray_accent_border_opa" style_border_side="left"
                        style_radius="#border_radius" style_pad_all="0" scrollable="false" clickable="false"/>
                <!-- Right side accent line -->
                <lv_obj width="#space_xs" height="#tray_accent_height" align="right_mid"
                        style_translate_x="-#tray_accent_offset" style_border_width="#space_xxs"
                        style_border_color="#text" style_border_opa="#tray_accent_border_opa" style_border_side="right"
                        style_radius="#border_radius" style_pad_all="0" scrollable="false" clickable="false"/>
              </lv_obj>
            </lv_obj>
          </lv_obj>
        </ui_card>
        <!-- Path Canvas - shows routing from slots to nozzle (no card border)
             Uses flex_grow="1" to fill remaining vertical space in left column -->
        <lv_obj name="path_container"
                width="100%" flex_grow="1" style_pad_all="0" flex_flow="column" style_flex_main_place="start"
                style_flex_cross_place="center" scrollable="false">
          <!-- Filament Path Canvas
               Shows schematic view of filament routing:
               - Slots at top (entry points)
               - Prep sensors (for AFC/hub topology)
               - Hub/Selector in center
               - Output to toolhead sensor
               - Nozzle at bottom

               All configuration (slot_count, topology, active_slot, etc.)
               set programmatically by C++ from AmsState/backend data.
               Click on slot entry points to trigger filament load.

               Uses flex_grow="1" so canvas height scales with screen size.
               All vertical segments scale proportionally via Y ratios. -->
          <filament_path_canvas name="path_canvas" width="100%" flex_grow="1"/>
        </lv_obj>
      </lv_obj>
      <!-- ================================================================== -->
      <!-- RIGHT COLUMN: Status & Controls                                   -->
      <!-- ================================================================== -->
      <lv_obj name="right_column"
              width="#right_col_width" height="100%" style_pad_all="0" scrollable="false" flex_flow="column"
              style_flex_main_place="start" style_flex_cross_place="center" style_pad_gap="#space_sm">
        <!-- Currently Loaded Section Header -->
        <text_small width="100%" text="Currently Loaded" translation_tag="Currently Loaded"/>
        <!-- Currently Loaded Card - horizontal layout: swatch left, details stacked right -->
        <ui_card name="current_loaded_card"
                 width="100%" height="content" style_radius="#border_radius" style_pad_all="#space_sm" flex_flow="row"
                 style_flex_main_place="start" style_flex_cross_place="center" style_pad_gap="#space_sm">
          <!-- Color swatch for current filament (left side) -->
          <lv_obj name="current_swatch"
                  width="#current_swatch_size" height="#current_swatch_size" style_radius="#border_radius"
                  style_bg_color="#text_muted" style_bg_opa="255" style_border_width="#space_xxs"
                  style_border_color="#text_muted" style_border_opa="80" scrollable="false" clickable="false"/>
          <!-- Details column (stacked to the right of swatch) -->
          <!-- flex_grow="1" fills remaining width after swatch for text wrapping -->
          <lv_obj name="current_details"
                  height="content" style_pad_all="0" flex_flow="column" style_flex_main_place="center"
                  style_flex_cross_place="start" style_pad_gap="0" scrollable="false" flex_grow="1">
            <!-- Primary label: material name (wraps for long names like "Generic / PLA") -->
            <text_body name="current_material" width="100%" bind_text="ams_current_material_text" long_mode="wrap"/>
            <!-- Secondary info row: Slot • Weight -->
            <lv_obj name="secondary_info_row"
                    width="content" height="content" style_pad_all="0" flex_flow="row" style_flex_main_place="start"
                    style_pad_gap="#space_xs" scrollable="false">
              <!-- Slot indicator -->
              <text_small name="current_slot_label" bind_text="ams_current_slot_text"/>
              <!-- Separator dot - hidden when no weight data -->
              <text_small name="weight_separator" text="•" translation_tag="•">
                <bind_flag_if_eq subject="ams_current_has_weight" flag="hidden" ref_value="0"/>
              </text_small>
              <!-- Weight - hidden when not available -->
              <text_small name="current_weight_label" bind_text="ams_current_weight_text">
                <bind_flag_if_eq subject="ams_current_has_weight" flag="hidden" ref_value="0"/>
              </text_small>
            </lv_obj>
          </lv_obj>
        </ui_card>
        <!-- Status Section -->
        <lv_obj name="status_section"
                width="100%" height="content" style_pad_all="#space_sm" flex_flow="row" style_flex_main_place="center"
                style_flex_cross_place="center" style_pad_gap="#space_sm" scrollable="false">
          <!-- Status label - bound to ams_action_detail subject -->
          <text_body name="status_label" bind_text="ams_action_detail" style_text_align="center" flex_grow="1"/>
        </lv_obj>
        <!-- Step Progress Stepper (shown during load operations) -->
        <lv_obj name="progress_stepper_container"
                width="100%" height="150" style_pad_all="0" scrollable="false" hidden="true">
          <!-- Step progress widget created dynamically by AmsPanel -->
        </lv_obj>
        <!-- Flex spacer - pushes action buttons to bottom of column -->
        <lv_obj width="1" style_pad_all="0" scrollable="false" flex_grow="1"/>
        <!-- Action Buttons Container - hidden during ANY operation (ams_action != IDLE) -->
        <lv_obj name="action_buttons_container" width="100%"
                height="content" style_pad_all="0" style_pad_gap="#space_sm" flex_flow="column"
                style_flex_main_place="start" style_flex_cross_place="center" scrollable="false">
          <bind_flag_if_not_eq subject="ams_action" flag="hidden" ref_value="0"/>
          <!-- Bypass Toggle Row (only shown if bypass supported - separate concern from action state) -->
          <lv_obj name="bypass_row"
                  width="100%" height="#button_height" style_pad_all="0" flex_flow="row"
                  style_flex_main_place="space_between" style_flex_cross_place="center" scrollable="false">
            <bind_flag_if_eq subject="ams_supports_bypass" flag="hidden" ref_value="0"/>
            <!-- Left side: icon + label -->
            <lv_obj height="content"
                    style_pad_all="0" flex_flow="row" style_flex_cross_place="center" style_pad_gap="#space_xs"
                    scrollable="false">
              <icon src="source_branch" size="sm"/>
              <text_body text="Bypass" translation_tag="Bypass"/>
            </lv_obj>
            <!-- Right side: toggle switch - state bound to ams_bypass_active subject -->
            <ui_switch name="bypass_switch" size="small">
              <bind_state_if_eq subject="ams_bypass_active" state="checked" ref_value="1"/>
              <event_cb trigger="value_changed" callback="ams_bypass_toggled_cb"/>
            </ui_switch>
          </lv_obj>
          <!-- Unload Button (full width) - hidden for tool changers -->
          <ui_button name="btn_unload" width="100%" variant="secondary" icon="tray_arrow_up" text="Unload" translation_tag="Unload">
            <bind_flag_if_eq subject="ams_type" flag="hidden" ref_value="4"/>
            <bind_state_if_eq subject="ams_filament_loaded" state="disabled" ref_value="0"/>
            <event_cb trigger="clicked" callback="ams_unload_clicked_cb"/>
          </ui_button>
          <!-- Reset Button (full width) -->
          <ui_button name="btn_reset" width="100%" variant="secondary" icon="refresh" text="Reset" translation_tag="Reset">
            <event_cb trigger="clicked" callback="ams_reset_clicked_cb"/>
          </ui_button>
          <!-- Settings Button (full width, primary variant by default) -->
          <ui_button name="btn_settings" width="100%" icon="settings" text="Settings" translation_tag="Settings">
            <event_cb trigger="clicked" callback="on_ams_panel_settings_clicked"/>
          </ui_button>
        </lv_obj>
        <!-- Dryer Card (hidden when dryer not supported or for tool changers) -->
        <ams_dryer_card name="dryer_card"/>
        <!-- Visibility controlled by binding inside ams_dryer_card.xml -->
      </lv_obj>
    </lv_obj>
  </view>
</component>
