<?xml version="1.0"?>
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<component>
  <view name="input_shaper_panel"
        extends="lv_obj" width="#overlay_panel_width" height="100%" align="right_mid" style_border_width="0"
        style_pad_all="0" style_bg_opa="255" style_bg_color="#card_bg" scrollable="false" flex_flow="column">
    <!-- Header Bar -->
    <header_bar name="overlay_header" title="Input Shaper"/>
    <!-- Content Area -->
    <lv_obj name="panel_content"
            width="100%" flex_grow="1" style_bg_opa="0" style_border_width="0" style_pad_all="#space_lg"
            style_pad_gap="#space_md" scrollable="true" scroll_dir="ver" flex_flow="column">
      <!-- ============================================================ -->
      <!-- STATE: IDLE - Clean, compact calibration interface -->
      <!-- ============================================================ -->
      <lv_obj name="state_idle"
              width="100%" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="column"
              style_pad_gap="#space_md" scrollable="false">
        <bind_flag_if_not_eq subject="input_shaper_state" flag="hidden" ref_value="0"/>
        <!-- Hero section: icon + title + help button -->
        <lv_obj width="100%"
                height="content" style_bg_color="#app_bg" style_bg_opa="255" style_radius="#border_radius"
                style_border_width="0" style_pad_all="#space_lg" flex_flow="column" style_flex_main_place="center"
                style_flex_cross_place="center" style_pad_gap="#space_sm" scrollable="false">
          <!-- Top row: icon and help button -->
          <lv_obj width="100%"
                  height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="row"
                  style_flex_main_place="center" style_flex_cross_place="center" scrollable="false">
            <icon src="sine_wave" size="lg" variant="primary"/>
            <!-- Spacer to push help button right -->
            <lv_obj height="1" flex_grow="1" scrollable="false"/>
            <!-- Help button -->
            <ui_button name="btn_help" width="36" height="36" variant="ghost" icon="help_circle">
              <event_cb trigger="clicked" callback="input_shaper_help_cb"/>
            </ui_button>
          </lv_obj>
          <text_heading text="Reduce Ringing" style_text_align="center"/>
          <text_small text="Calibrate resonance compensation" style_text_align="center"/>
        </lv_obj>
        <!-- Calibration buttons - side by side -->
        <lv_obj width="100%"
                height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="row"
                style_pad_gap="#space_md" scrollable="false">
          <!-- Calibrate X Button -->
          <ui_button name="btn_calibrate_x" height="72" flex_grow="1" icon="axis_x_arrow" text="Calibrate X">
            <event_cb trigger="clicked" callback="input_shaper_calibrate_x_cb"/>
          </ui_button>
          <!-- Calibrate Y Button -->
          <ui_button name="btn_calibrate_y" height="72" flex_grow="1" icon="axis_y_arrow" text="Calibrate Y">
            <event_cb trigger="clicked" callback="input_shaper_calibrate_y_cb"/>
          </ui_button>
        </lv_obj>
        <!-- Measure Noise Button (secondary) -->
        <ui_button name="btn_measure_noise"
                   width="100%" variant="secondary" icon="vibrate" text="Measure Noise">
          <event_cb trigger="clicked" callback="input_shaper_measure_noise_cb"/>
        </ui_button>
      </lv_obj>
      <!-- ============================================================ -->
      <!-- STATE: MEASURING - Progress spinner -->
      <!-- ============================================================ -->
      <lv_obj name="state_measuring"
              width="100%" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="column"
              style_pad_gap="#space_lg" scrollable="false">
        <bind_flag_if_not_eq subject="input_shaper_state" flag="hidden" ref_value="1"/>
        <!-- Spinner and status container -->
        <lv_obj width="100%"
                height="content" style_min_height="160" style_bg_color="#app_bg" style_bg_opa="255"
                style_radius="#border_radius" style_border_width="0" style_pad_all="#space_xl" flex_flow="column"
                style_flex_main_place="center" style_flex_cross_place="center" style_pad_gap="#space_md"
                scrollable="false">
          <!-- Animated spinner -->
          <spinner size="lg"/>
          <text_heading name="status_label" text="Calibrating..." style_text_align="center"/>
          <text_small text="This may take 1-2 minutes" style_text_align="center"/>
        </lv_obj>
        <!-- Cancel button -->
        <ui_button name="btn_cancel"
                   width="100%" variant="secondary" icon="close" text="Cancel">
          <event_cb trigger="clicked" callback="input_shaper_cancel_cb"/>
        </ui_button>
      </lv_obj>
      <!-- ============================================================ -->
      <!-- STATE: RESULTS - Shaper recommendations -->
      <!-- ============================================================ -->
      <lv_obj name="state_results"
              width="100%" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="column"
              style_pad_gap="#space_md" scrollable="false">
        <bind_flag_if_not_eq subject="input_shaper_state" flag="hidden" ref_value="2"/>
        <!-- Success banner with recommendation -->
        <lv_obj width="100%"
                height="content" style_bg_color="#success" style_bg_opa="40" style_radius="#border_radius"
                style_border_width="1" style_border_color="#success" style_pad_all="#space_md" flex_flow="row"
                style_flex_cross_place="center" style_pad_gap="#space_sm" scrollable="false">
          <icon src="check_circle" size="md" color="#success"/>
          <lv_obj height="content"
                  flex_grow="1" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="column"
                  scrollable="false">
            <text_small text="Recommended" style_text_color="#success"/>
            <text_heading name="recommendation_label" text="mzv @ 36.7 Hz"/>
          </lv_obj>
        </lv_obj>
        <!-- Frequency response chart container (populated programmatically) -->
        <lv_obj name="chart_container"
                width="100%" height="160" style_bg_color="#app_bg" style_bg_opa="255" style_radius="#border_radius"
                style_border_width="0" style_pad_all="#space_sm" scrollable="false">
          <!-- FrequencyResponseChart created here by InputShaperPanel -->
        </lv_obj>
        <!-- Results table header -->
        <lv_obj width="100%"
                height="content" style_bg_opa="0" style_border_width="0" style_pad_left="#space_md"
                style_pad_right="#space_md" style_pad_top="0" style_pad_bottom="0" flex_flow="row" scrollable="false">
          <text_small width="40%" text="Shaper"/>
          <text_small width="30%" text="Freq"/>
          <text_small width="30%" text="Vibration"/>
        </lv_obj>
        <!-- Results rows container -->
        <lv_obj width="100%"
                height="content" style_bg_color="#app_bg" style_bg_opa="255" style_radius="#border_radius"
                style_border_width="0" style_pad_all="0" flex_flow="column" scrollable="false">
          <!-- Row 0 -->
          <lv_obj name="shaper_row_0"
                  width="100%" height="40" style_bg_opa="0" style_border_width="0" style_pad_left="#space_md"
                  style_pad_right="#space_md" style_pad_top="#space_xs" style_pad_bottom="#space_xs" flex_flow="row"
                  style_flex_cross_place="center" scrollable="false">
            <bind_flag_if_eq subject="shaper_0_visible" flag="hidden" ref_value="0"/>
            <text_body width="40%" bind_text="shaper_0_type"/>
            <text_small width="30%" bind_text="shaper_0_freq"/>
            <text_small width="30%" bind_text="shaper_0_vib"/>
          </lv_obj>
          <!-- Row 1 -->
          <lv_obj name="shaper_row_1"
                  width="100%" height="40" style_bg_opa="0" style_border_width="0" style_pad_left="#space_md"
                  style_pad_right="#space_md" style_pad_top="#space_xs" style_pad_bottom="#space_xs" flex_flow="row"
                  style_flex_cross_place="center" scrollable="false">
            <bind_flag_if_eq subject="shaper_1_visible" flag="hidden" ref_value="0"/>
            <text_body width="40%" bind_text="shaper_1_type"/>
            <text_small width="30%" bind_text="shaper_1_freq"/>
            <text_small width="30%" bind_text="shaper_1_vib"/>
          </lv_obj>
          <!-- Row 2 -->
          <lv_obj name="shaper_row_2"
                  width="100%" height="40" style_bg_opa="0" style_border_width="0" style_pad_left="#space_md"
                  style_pad_right="#space_md" style_pad_top="#space_xs" style_pad_bottom="#space_xs" flex_flow="row"
                  style_flex_cross_place="center" scrollable="false">
            <bind_flag_if_eq subject="shaper_2_visible" flag="hidden" ref_value="0"/>
            <text_body width="40%" bind_text="shaper_2_type"/>
            <text_small width="30%" bind_text="shaper_2_freq"/>
            <text_small width="30%" bind_text="shaper_2_vib"/>
          </lv_obj>
          <!-- Row 3 -->
          <lv_obj name="shaper_row_3"
                  width="100%" height="40" style_bg_opa="0" style_border_width="0" style_pad_left="#space_md"
                  style_pad_right="#space_md" style_pad_top="#space_xs" style_pad_bottom="#space_xs" flex_flow="row"
                  style_flex_cross_place="center" scrollable="false">
            <bind_flag_if_eq subject="shaper_3_visible" flag="hidden" ref_value="0"/>
            <text_body width="40%" bind_text="shaper_3_type"/>
            <text_small width="30%" bind_text="shaper_3_freq"/>
            <text_small width="30%" bind_text="shaper_3_vib"/>
          </lv_obj>
          <!-- Row 4 -->
          <lv_obj name="shaper_row_4"
                  width="100%" height="40" style_bg_opa="0" style_border_width="0" style_pad_left="#space_md"
                  style_pad_right="#space_md" style_pad_top="#space_xs" style_pad_bottom="#space_xs" flex_flow="row"
                  style_flex_cross_place="center" scrollable="false">
            <bind_flag_if_eq subject="shaper_4_visible" flag="hidden" ref_value="0"/>
            <text_body width="40%" bind_text="shaper_4_type"/>
            <text_small width="30%" bind_text="shaper_4_freq"/>
            <text_small width="30%" bind_text="shaper_4_vib"/>
          </lv_obj>
        </lv_obj>
        <!-- Action buttons -->
        <lv_obj width="100%"
                height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="row"
                style_pad_gap="#space_md" scrollable="false">
          <!-- Close button (secondary) -->
          <ui_button name="btn_close" flex_grow="1" variant="secondary" text="Close">
            <event_cb trigger="clicked" callback="input_shaper_close_cb"/>
          </ui_button>
          <!-- Apply button (primary) -->
          <ui_button name="btn_apply"
                     flex_grow="1" variant="success" icon="check" text="Apply">
            <event_cb trigger="clicked" callback="input_shaper_apply_cb"/>
          </ui_button>
        </lv_obj>
        <!-- Save Config warning -->
        <lv_obj width="100%"
                height="content" style_bg_color="#warning" style_bg_opa="25" style_radius="#border_radius"
                style_border_width="1" style_border_color="#warning" style_pad_all="#space_sm" flex_flow="row"
                style_flex_cross_place="center" style_pad_gap="#space_sm" scrollable="false">
          <icon src="alert" size="sm" color="#warning"/>
          <text_small text="Apply saves for this session only" style_text_color="#warning" flex_grow="1"/>
          <ui_button name="btn_save_config" width="content" height="#space_2xl" variant="warning" text="Save Config">
            <event_cb trigger="clicked" callback="input_shaper_save_config_cb"/>
          </ui_button>
        </lv_obj>
        <!-- Test Print button (enables tuning tower for visual comparison) -->
        <ui_button name="btn_test_print"
                   width="100%" variant="secondary" icon="printer_3d" text="Test Print">
          <event_cb trigger="clicked" callback="input_shaper_print_test_cb"/>
        </ui_button>
      </lv_obj>
      <!-- ============================================================ -->
      <!-- STATE: ERROR - Error message and retry -->
      <!-- ============================================================ -->
      <lv_obj name="state_error"
              width="100%" height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="column"
              style_pad_gap="#space_md" scrollable="false">
        <bind_flag_if_not_eq subject="input_shaper_state" flag="hidden" ref_value="3"/>
        <!-- Error card -->
        <lv_obj width="100%"
                height="content" style_bg_color="#danger" style_bg_opa="25" style_radius="#border_radius"
                style_border_width="1" style_border_color="#danger" style_pad_all="#space_lg" flex_flow="column"
                style_flex_main_place="center" style_flex_cross_place="center" style_pad_gap="#space_sm"
                scrollable="false">
          <icon src="alert" size="lg" variant="danger"/>
          <text_heading text="Calibration Failed" style_text_align="center" style_text_color="#danger"/>
          <text_muted name="error_message" text="An error occurred during calibration." style_text_align="center"/>
        </lv_obj>
        <!-- Troubleshooting tips -->
        <lv_obj width="100%"
                height="content" style_bg_color="#app_bg" style_bg_opa="255" style_radius="#border_radius"
                style_border_width="0" style_pad_all="#space_md" flex_flow="column" style_pad_gap="#space_xs"
                scrollable="false">
          <text_small text="Troubleshooting:"/>
          <text_small text="- Ensure ADXL345 is connected"/>
          <text_small text="- Check [resonance_tester] in printer.cfg"/>
          <text_small text="- Try Measure Noise first"/>
        </lv_obj>
        <!-- Action buttons -->
        <lv_obj width="100%"
                height="content" style_bg_opa="0" style_border_width="0" style_pad_all="0" flex_flow="row"
                style_pad_gap="#space_md" scrollable="false">
          <!-- Back button -->
          <ui_button name="btn_error_back" flex_grow="1" variant="secondary" text="Back">
            <event_cb trigger="clicked" callback="input_shaper_close_cb"/>
          </ui_button>
          <!-- Retry button -->
          <ui_button name="btn_retry" flex_grow="1" icon="refresh" text="Retry">
            <event_cb trigger="clicked" callback="input_shaper_retry_cb"/>
          </ui_button>
        </lv_obj>
      </lv_obj>
    </lv_obj>
  </view>
</component>
