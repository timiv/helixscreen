#!/usr/bin/env python3
"""Fill in new (empty) translation keys across all language YAML files.

Only touches keys with empty string values — leaves existing translations intact.
Uses line-level replacement to preserve YAML formatting.
"""

import re
import sys
from pathlib import Path

# New translations per language — ONLY for keys that are currently empty
TRANSLATIONS = {
    "de": {
        "--°C": "--°C",
        "AFC failure reset complete": "AFC-Fehler zurückgesetzt",
        "AFC failure reset failed": "AFC-Fehler-Reset fehlgeschlagen",
        "AFC reset complete": "AFC-Reset abgeschlossen",
        "AFC reset failed": "AFC-Reset fehlgeschlagen",
        "ALL DEVICES": "ALLE GERÄTE",
        "Clear Spool": "Spule entfernen",
        "Configure": "Konfigurieren",
        "Control power switches and relays": "Schalter und Relais steuern",
        "Eject": "Auswerfen",
        "External Spool": "Externe Spule",
        "Extrude": "Extrudieren",
        "Extrude Speed": "Extrusionsgeschwindigkeit",
        "Extrude/retract feedrate (Saved)": "Extrusions-/Rückzugsgeschwindigkeit (Gespeichert)",
        "Home Widgets": "Start-Widgets",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "Mit Spoolman verknüpfen",
        "Long press and drag to reorder": "Lange drücken und ziehen zum Sortieren",
        "MAIN POWER BUTTON": "HAUPTSCHALTER",
        "Maximum of 10 widgets can be enabled at once": "Maximal 10 Widgets können gleichzeitig aktiviert sein",
        "No spools found in Spoolman": "Keine Spulen in Spoolman gefunden",
        "POWER": "STROM",
        "Power Devices": "Stromgeräte",
        "Purging nozzle": "Düse wird gespült",
        "Restart": "Neustart",
        "Restart Firmware?": "Firmware neu starten?",
        "Retract": "Einziehen",
        "Run": "Ausführen",
        "Run Macro": "Makro ausführen",
        "Select Macro": "Makro auswählen",
        "Select Sensor": "Sensor auswählen",
        "Select Spool": "Spule auswählen",
        "Select sensor": "Sensor auswählen",
        "Select which devices the home screen power button controls": "Wählen Sie, welche Geräte der Startbildschirm-Schalter steuert",
        "Spool Info": "Spuleninfo",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "Klipper-Firmware wird neu gestartet. Aktive Vorgänge werden unterbrochen.",
        "Toggle and reorder status widgets": "Status-Widgets umschalten und sortieren",
        "Unlink": "Verknüpfung lösen",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "nicht erkannt",
    },
    "es": {
        "--°C": "--°C",
        "AFC failure reset complete": "Reinicio de fallo AFC completado",
        "AFC failure reset failed": "Error al reiniciar fallo AFC",
        "AFC reset complete": "Reinicio AFC completado",
        "AFC reset failed": "Error en reinicio AFC",
        "ALL DEVICES": "TODOS LOS DISPOSITIVOS",
        "Clear Spool": "Quitar bobina",
        "Configure": "Configurar",
        "Control power switches and relays": "Controlar interruptores y relés",
        "Eject": "Expulsar",
        "External Spool": "Bobina externa",
        "Extrude": "Extruir",
        "Extrude Speed": "Velocidad de extrusión",
        "Extrude/retract feedrate (Saved)": "Velocidad de extrusión/retracción (Guardada)",
        "Home Widgets": "Widgets de inicio",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "Vincular a Spoolman",
        "Long press and drag to reorder": "Mantener presionado y arrastrar para reordenar",
        "MAIN POWER BUTTON": "BOTÓN DE ENCENDIDO PRINCIPAL",
        "Maximum of 10 widgets can be enabled at once": "Se pueden activar un máximo de 10 widgets a la vez",
        "No spools found in Spoolman": "No se encontraron bobinas en Spoolman",
        "POWER": "ENERGÍA",
        "Power Devices": "Dispositivos de energía",
        "Purging nozzle": "Purgando boquilla",
        "Restart": "Reiniciar",
        "Restart Firmware?": "¿Reiniciar firmware?",
        "Retract": "Retraer",
        "Run": "Ejecutar",
        "Run Macro": "Ejecutar macro",
        "Select Macro": "Seleccionar macro",
        "Select Sensor": "Seleccionar sensor",
        "Select Spool": "Seleccionar bobina",
        "Select sensor": "Seleccionar sensor",
        "Select which devices the home screen power button controls": "Seleccione qué dispositivos controla el botón de encendido",
        "Spool Info": "Info de bobina",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "Se reiniciará el firmware de Klipper. Las operaciones activas se interrumpirán.",
        "Toggle and reorder status widgets": "Activar y reordenar widgets de estado",
        "Unlink": "Desvincular",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "no detectado",
    },
    "fr": {
        "--°C": "--°C",
        "AFC failure reset complete": "Réinitialisation erreur AFC terminée",
        "AFC failure reset failed": "Échec de la réinitialisation erreur AFC",
        "AFC reset complete": "Réinitialisation AFC terminée",
        "AFC reset failed": "Échec de la réinitialisation AFC",
        "ALL DEVICES": "TOUS LES APPAREILS",
        "Clear Spool": "Retirer la bobine",
        "Configure": "Configurer",
        "Control power switches and relays": "Contrôler les interrupteurs et relais",
        "Eject": "Éjecter",
        "External Spool": "Bobine externe",
        "Extrude": "Extruder",
        "Extrude Speed": "Vitesse d'extrusion",
        "Extrude/retract feedrate (Saved)": "Vitesse d'extrusion/rétraction (Sauvegardée)",
        "Home Widgets": "Widgets d'accueil",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "Lier à Spoolman",
        "Long press and drag to reorder": "Appui long et glisser pour réorganiser",
        "MAIN POWER BUTTON": "BOUTON D'ALIMENTATION PRINCIPAL",
        "Maximum of 10 widgets can be enabled at once": "Un maximum de 10 widgets peuvent être activés simultanément",
        "No spools found in Spoolman": "Aucune bobine trouvée dans Spoolman",
        "POWER": "ALIMENTATION",
        "Power Devices": "Appareils électriques",
        "Purging nozzle": "Purge de la buse",
        "Restart": "Redémarrer",
        "Restart Firmware?": "Redémarrer le firmware ?",
        "Retract": "Rétracter",
        "Run": "Exécuter",
        "Run Macro": "Exécuter la macro",
        "Select Macro": "Sélectionner une macro",
        "Select Sensor": "Sélectionner un capteur",
        "Select Spool": "Sélectionner une bobine",
        "Select sensor": "Sélectionner un capteur",
        "Select which devices the home screen power button controls": "Sélectionnez les appareils contrôlés par le bouton d'alimentation",
        "Spool Info": "Info bobine",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "Le firmware Klipper sera redémarré. Les opérations actives seront interrompues.",
        "Toggle and reorder status widgets": "Activer et réorganiser les widgets de statut",
        "Unlink": "Dissocier",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "non détecté",
    },
    "it": {
        "--°C": "--°C",
        "AFC failure reset complete": "Reset errore AFC completato",
        "AFC failure reset failed": "Reset errore AFC fallito",
        "AFC reset complete": "Reset AFC completato",
        "AFC reset failed": "Reset AFC fallito",
        "ALL DEVICES": "TUTTI I DISPOSITIVI",
        "Clear Spool": "Rimuovi bobina",
        "Configure": "Configura",
        "Control power switches and relays": "Controlla interruttori e relè",
        "Eject": "Espelli",
        "External Spool": "Bobina esterna",
        "Extrude": "Estrusione",
        "Extrude Speed": "Velocità di estrusione",
        "Extrude/retract feedrate (Saved)": "Velocità estrusione/retrazione (Salvata)",
        "Home Widgets": "Widget della home",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "Collega a Spoolman",
        "Long press and drag to reorder": "Tieni premuto e trascina per riordinare",
        "MAIN POWER BUTTON": "PULSANTE DI ACCENSIONE PRINCIPALE",
        "Maximum of 10 widgets can be enabled at once": "È possibile attivare un massimo di 10 widget alla volta",
        "No spools found in Spoolman": "Nessuna bobina trovata in Spoolman",
        "POWER": "ALIMENTAZIONE",
        "Power Devices": "Dispositivi di alimentazione",
        "Purging nozzle": "Spurgo ugello",
        "Restart": "Riavvia",
        "Restart Firmware?": "Riavviare il firmware?",
        "Retract": "Retrazione",
        "Run": "Esegui",
        "Run Macro": "Esegui macro",
        "Select Macro": "Seleziona macro",
        "Select Sensor": "Seleziona sensore",
        "Select Spool": "Seleziona bobina",
        "Select sensor": "Seleziona sensore",
        "Select which devices the home screen power button controls": "Seleziona quali dispositivi controlla il pulsante di accensione",
        "Spool Info": "Info bobina",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "Il firmware Klipper verrà riavviato. Le operazioni attive saranno interrotte.",
        "Toggle and reorder status widgets": "Attiva e riordina i widget di stato",
        "Unlink": "Scollega",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "non rilevato",
    },
    "ja": {
        "--°C": "--°C",
        "AFC failure reset complete": "AFCエラーリセット完了",
        "AFC failure reset failed": "AFCエラーリセット失敗",
        "AFC reset complete": "AFCリセット完了",
        "AFC reset failed": "AFCリセット失敗",
        "ALL DEVICES": "すべてのデバイス",
        "Clear Spool": "スプールを解除",
        "Configure": "設定",
        "Control power switches and relays": "電源スイッチとリレーを制御",
        "Eject": "取り出し",
        "External Spool": "外部スプール",
        "Extrude": "押し出し",
        "Extrude Speed": "押し出し速度",
        "Extrude/retract feedrate (Saved)": "押し出し/引き戻し速度（保存済み）",
        "Home Widgets": "ホームウィジェット",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "Spoolmanに連携",
        "Long press and drag to reorder": "長押ししてドラッグで並べ替え",
        "MAIN POWER BUTTON": "メイン電源ボタン",
        "Maximum of 10 widgets can be enabled at once": "一度に有効にできるウィジェットは最大10個です",
        "No spools found in Spoolman": "Spoolmanにスプールが見つかりません",
        "POWER": "電源",
        "Power Devices": "電源デバイス",
        "Purging nozzle": "ノズルをパージ中",
        "Restart": "再起動",
        "Restart Firmware?": "ファームウェアを再起動しますか？",
        "Retract": "引き戻し",
        "Run": "実行",
        "Run Macro": "マクロを実行",
        "Select Macro": "マクロを選択",
        "Select Sensor": "センサーを選択",
        "Select Spool": "スプールを選択",
        "Select sensor": "センサーを選択",
        "Select which devices the home screen power button controls": "ホーム画面の電源ボタンで制御するデバイスを選択",
        "Spool Info": "スプール情報",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "Klipperファームウェアを再起動します。実行中の操作は中断されます。",
        "Toggle and reorder status widgets": "ステータスウィジェットの切り替えと並べ替え",
        "Unlink": "連携解除",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "未検出",
    },
    "pt": {
        "--°C": "--°C",
        "AFC failure reset complete": "Reinício de falha AFC concluído",
        "AFC failure reset failed": "Falha ao reiniciar erro AFC",
        "AFC reset complete": "Reinício AFC concluído",
        "AFC reset failed": "Falha no reinício AFC",
        "ALL DEVICES": "TODOS OS DISPOSITIVOS",
        "Clear Spool": "Remover bobina",
        "Configure": "Configurar",
        "Control power switches and relays": "Controlar interruptores e relés",
        "Eject": "Ejetar",
        "External Spool": "Bobina externa",
        "Extrude": "Extrudar",
        "Extrude Speed": "Velocidade de extrusão",
        "Extrude/retract feedrate (Saved)": "Velocidade de extrusão/retração (Salva)",
        "Home Widgets": "Widgets da tela inicial",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "Vincular ao Spoolman",
        "Long press and drag to reorder": "Pressione e arraste para reordenar",
        "MAIN POWER BUTTON": "BOTÃO DE ENERGIA PRINCIPAL",
        "Maximum of 10 widgets can be enabled at once": "No máximo 10 widgets podem ser ativados de uma vez",
        "No spools found in Spoolman": "Nenhuma bobina encontrada no Spoolman",
        "POWER": "ENERGIA",
        "Power Devices": "Dispositivos de energia",
        "Purging nozzle": "Purgando bico",
        "Restart": "Reiniciar",
        "Restart Firmware?": "Reiniciar firmware?",
        "Retract": "Retrair",
        "Run": "Executar",
        "Run Macro": "Executar macro",
        "Select Macro": "Selecionar macro",
        "Select Sensor": "Selecionar sensor",
        "Select Spool": "Selecionar bobina",
        "Select sensor": "Selecionar sensor",
        "Select which devices the home screen power button controls": "Selecione quais dispositivos o botão de energia controla",
        "Spool Info": "Info da bobina",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "O firmware Klipper será reiniciado. Operações ativas serão interrompidas.",
        "Toggle and reorder status widgets": "Ativar e reordenar widgets de estado",
        "Unlink": "Desvincular",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "não detectado",
    },
    "ru": {
        "--°C": "--°C",
        "AFC failure reset complete": "Сброс ошибки AFC завершён",
        "AFC failure reset failed": "Ошибка сброса ошибки AFC",
        "AFC reset complete": "Сброс AFC завершён",
        "AFC reset failed": "Ошибка сброса AFC",
        "ALL DEVICES": "ВСЕ УСТРОЙСТВА",
        "Clear Spool": "Убрать катушку",
        "Configure": "Настроить",
        "Control power switches and relays": "Управление выключателями и реле",
        "Eject": "Извлечь",
        "External Spool": "Внешняя катушка",
        "Extrude": "Экструзия",
        "Extrude Speed": "Скорость экструзии",
        "Extrude/retract feedrate (Saved)": "Скорость экструзии/ретракции (Сохранено)",
        "Home Widgets": "Виджеты главного экрана",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "Привязать к Spoolman",
        "Long press and drag to reorder": "Удерживайте и перетащите для сортировки",
        "MAIN POWER BUTTON": "ГЛАВНАЯ КНОПКА ПИТАНИЯ",
        "Maximum of 10 widgets can be enabled at once": "Одновременно можно включить не более 10 виджетов",
        "No spools found in Spoolman": "Катушки не найдены в Spoolman",
        "POWER": "ПИТАНИЕ",
        "Power Devices": "Устройства питания",
        "Purging nozzle": "Продувка сопла",
        "Restart": "Перезапуск",
        "Restart Firmware?": "Перезапустить прошивку?",
        "Retract": "Ретракция",
        "Run": "Запуск",
        "Run Macro": "Запустить макрос",
        "Select Macro": "Выбрать макрос",
        "Select Sensor": "Выбрать датчик",
        "Select Spool": "Выбрать катушку",
        "Select sensor": "Выбрать датчик",
        "Select which devices the home screen power button controls": "Выберите устройства для кнопки питания на главном экране",
        "Spool Info": "Информация о катушке",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "Прошивка Klipper будет перезапущена. Активные операции будут прерваны.",
        "Toggle and reorder status widgets": "Включение и сортировка виджетов статуса",
        "Unlink": "Отвязать",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "не обнаружено",
    },
    "zh": {
        "--°C": "--°C",
        "AFC failure reset complete": "AFC故障重置完成",
        "AFC failure reset failed": "AFC故障重置失败",
        "AFC reset complete": "AFC重置完成",
        "AFC reset failed": "AFC重置失败",
        "ALL DEVICES": "所有设备",
        "Clear Spool": "移除料盘",
        "Configure": "配置",
        "Control power switches and relays": "控制电源开关和继电器",
        "Eject": "弹出",
        "External Spool": "外部料盘",
        "Extrude": "挤出",
        "Extrude Speed": "挤出速度",
        "Extrude/retract feedrate (Saved)": "挤出/回抽速度（已保存）",
        "Home Widgets": "主页小组件",
        "Join us at discord.gg/helixscreen": "Join us at discord.gg/helixscreen",
        "Link to Spoolman": "关联到Spoolman",
        "Long press and drag to reorder": "长按拖动以重新排序",
        "MAIN POWER BUTTON": "主电源按钮",
        "Maximum of 10 widgets can be enabled at once": "最多可同时启用10个小组件",
        "No spools found in Spoolman": "Spoolman中未找到料盘",
        "POWER": "电源",
        "Power Devices": "电源设备",
        "Purging nozzle": "正在清洗喷嘴",
        "Restart": "重启",
        "Restart Firmware?": "重启固件？",
        "Retract": "回抽",
        "Run": "运行",
        "Run Macro": "运行宏",
        "Select Macro": "选择宏",
        "Select Sensor": "选择传感器",
        "Select Spool": "选择料盘",
        "Select sensor": "选择传感器",
        "Select which devices the home screen power button controls": "选择主页电源按钮控制的设备",
        "Spool Info": "料盘信息",
        "This will restart Klipper firmware. Any active operations will be interrupted.": "将重启Klipper固件。所有正在进行的操作将被中断。",
        "Toggle and reorder status widgets": "切换和排序状态小组件",
        "Unlink": "取消关联",
        "Visit docs.helixscreen.org": "Visit docs.helixscreen.org",
        "X": "X",
        "Y": "Y",
        "not detected": "未检测到",
    },
}


def yaml_escape(value: str) -> str:
    """Escape a value for safe YAML inline string representation."""
    # If it contains single quotes, use double-quote wrapping
    if "'" in value:
        # Escape any double quotes inside
        escaped = value.replace("\\", "\\\\").replace('"', '\\"')
        return f'"{escaped}"'
    # Otherwise use single quotes (standard in these files)
    return f"'{value}'"


def fill_translations(yaml_dir: Path):
    """Fill empty translation values using line-level replacement."""
    for lang, trans_map in TRANSLATIONS.items():
        filepath = yaml_dir / f"{lang}.yml"
        if not filepath.exists():
            print(f"  SKIP {lang}.yml (not found)")
            continue

        with open(filepath, "r", encoding="utf-8") as f:
            lines = f.readlines()

        filled = 0
        new_lines = []
        for line in lines:
            # Match lines like "  key: ''" (empty single-quoted value)
            # The YAML files use 2-space indent under "translations:"
            match = re.match(r"^(\s+)(.*?):\s*''\s*$", line)
            if match:
                indent = match.group(1)
                key = match.group(2)
                # Remove surrounding quotes from key if present
                if key.startswith("'") and key.endswith("'"):
                    key = key[1:-1]
                elif key.startswith('"') and key.endswith('"'):
                    key = key[1:-1]

                # Normalize key: YAML unquoted values preserve \" literally,
                # but Python dict keys use just " (since \" in Python = ")
                normalized_key = key.replace('\\"', '"')
                lookup_key = key if key in trans_map else normalized_key
                if lookup_key in trans_map and trans_map[lookup_key]:
                    new_val = yaml_escape(trans_map[lookup_key])
                    new_lines.append(f"{indent}{match.group(2)}: {new_val}\n")
                    filled += 1
                    continue

            new_lines.append(line)

        with open(filepath, "w", encoding="utf-8") as f:
            f.writelines(new_lines)

        print(f"  {lang}.yml: {filled} keys translated")


if __name__ == "__main__":
    yaml_dir = Path(__file__).parent.parent / "translations"
    print(f"Filling new translations in {yaml_dir}")
    fill_translations(yaml_dir)
    print("Done!")
